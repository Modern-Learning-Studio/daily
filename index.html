<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLS DAILY</title>
    <style>
        /* --- Reset & Base Styles --- */
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --bg-color: #ffffff;
            --text-color: #212529;
            --border-color: #dee2e6;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --border-radius: 0.5rem;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; }
        body { background-color: var(--light-color); color: var(--text-color); display: flex; flex-direction: column; min-height: 100vh; }
        .hidden { display: none !important; }

        /* --- Layout & Containers --- */
        #app-container { width: 100%; max-width: 1200px; margin: 0 auto; padding: 1rem; flex-grow: 1; }
        .app-header {
            position: sticky; top: 0; z-index: 1000;
            background-color: var(--bg-color);
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .header-brand { font-size: 1.5rem; font-weight: bold; }
        .header-controls { display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; }
        .user-badge { font-weight: 500; padding: 0.3rem 0.6rem; border-radius: var(--border-radius); background-color: var(--light-color); }
        .user-badge.admin { background-color: var(--warning-color); color: var(--text-color); }
        .user-badge.staff { background-color: var(--primary-color); color: white; }

        /* --- Login Screen --- */
        #login-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 80vh;
        }
        .login-card {
            background-color: var(--bg-color);
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        .login-card h1 { margin-bottom: 1.5rem; }

        /* --- Dashboard & Tabs --- */
        .dashboard { display: flex; flex-direction: column; gap: 1.5rem; }
        .tab-nav { display: flex; flex-wrap: wrap; gap: 0.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .kpi-card { background: var(--bg-color); padding: 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow); text-align: center; }
        .kpi-card h3 { font-size: 1rem; color: var(--secondary-color); margin-bottom: 0.5rem; }
        .kpi-card p { font-size: 1.75rem; font-weight: bold; }

        /* --- Forms & Inputs --- */
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        input[type="text"], input[type="date"], input[type="time"], input[type="number"], input[type="email"], input[type="tel"], select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
        }
        textarea { min-height: 100px; resize: vertical; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .checkbox-group { display: flex; align-items: center; gap: 0.5rem; }

        /* --- Buttons --- */
        .btn {
            display: inline-block;
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            text-align: center;
            text-decoration: none;
            transition: background-color 0.2s;
        }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-secondary { background-color: var(--secondary-color); color: white; }
        .btn-secondary:hover { background-color: #545b62; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-warning { background-color: var(--warning-color); color: var(--text-color); }
        .btn-sm { padding: 0.3rem 0.6rem; font-size: 0.875rem; }
        .btn-block { width: 100%; display: block; }
        .tab-btn { background-color: var(--light-color); color: var(--primary-color); border: 1px solid var(--border-color); }
        .tab-btn.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }

        /* --- Tables --- */
        .table-container { overflow-x: auto; background: var(--bg-color); border-radius: var(--border-radius); box-shadow: var(--shadow); max-height: 60vh; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border-color); }
        thead th { position: sticky; top: 0; background-color: var(--light-color); z-index: 10; }
        tbody tr:hover { background-color: #f1f1f1; }
        .actions-cell { display: flex; gap: 0.5rem; flex-wrap: wrap; }

        /* --- Cards & Modals --- */
        .card { background-color: var(--bg-color); padding: 1.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow); }
        .card-header { font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color); }
        .notice-card { border-left: 5px solid var(--primary-color); margin-bottom: 1rem; }
        .notice-card.pinned { border-left-color: var(--warning-color); }
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex; justify-content: center; align-items: center;
            z-index: 2000;
        }
        .modal-content {
            background: var(--bg-color);
            padding: 2rem;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .modal-header h2 { margin: 0; }
        .close-modal { font-size: 1.5rem; background: none; border: none; cursor: pointer; }
        .profile-section { margin-top: 1.5rem; }
        .profile-section h3 { border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; margin-bottom: 1rem; }

        /* --- Utility & Responsive --- */
        .text-center { text-align: center; }
        .mt-1 { margin-top: 1rem; }
        .mb-1 { margin-bottom: 1rem; }
        .d-flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .align-center { align-items: center; }
        .gap-1 { gap: 1rem; }
        @media (max-width: 768px) {
            .app-header { flex-direction: column; align-items: flex-start; }
            .header-controls { width: 100%; justify-content: flex-start; }
            .form-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div id="app-container">
        <!-- Login Screen -->
        <div id="login-screen">
            <div class="login-card">
                <h1>MLS DAILY</h1>
                <div id="login-error" class="hidden" style="color: var(--danger-color); margin-bottom: 1rem;"></div>
                <form id="login-form">
                    <div class="form-group">
                        <label for="login-centre">Select Centre</label>
                        <select id="login-centre" required></select>
                    </div>
                    <div class="form-group">
                        <label for="login-pin">PIN</label>
                        <input type="text" id="login-pin" inputmode="numeric" autocomplete="off" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Login</button>
                </form>
            </div>
        </div>

        <!-- Main App View (Dashboard) -->
        <div id="main-app" class="hidden">
            <header class="app-header">
                <div class="header-brand">MLS DAILY</div>
                <div class="header-controls">
                    <span id="user-badge" class="user-badge"></span>
                    <button id="test-webhook-btn" class="btn btn-secondary btn-sm">Test</button>
                    <button id="sync-webhook-btn" class="btn btn-primary btn-sm">Sync &rarr; Webhook</button>
                    <button id="load-webhook-btn" class="btn btn-warning btn-sm">Load &larr; Webhook</button>
                    <button id="logout-btn" class="btn btn-danger btn-sm">Logout</button>
                </div>
            </header>
            
            <main id="dashboard-container" class="mt-1"></main>
        </div>
    </div>
    
    <!-- Modal Placeholder -->
    <div id="modal-container"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- App Namespace ---
        const App = {
            state: {},
            currentUser: null, // { id, name, role, centre }
            STATE_KEY: 'mls_daily_state_v4',
            ADMIN_PIN: '0000',

            // --- Initialization ---
            async init() {
                this.loadState();
                if (this.state.settings.webhook) {
                    await this.loadFromWebhook(true); // silent load on startup
                }
                this.render();
                this.addEventListeners(); // Add listeners once on init
            },
            
            // --- State Management ---
            getDefaultState() {
                const today = new Date().toISOString().split('T')[0];
                return {
                    settings: {
                        org: "MLS Innovations",
                        centres: [
                            "MLS - Colombo 4",
                            "Finnish Preschool - Park Road",
                            "Forest School - Piliyandala",
                            "SenSoMo - One Galle Face",
                            "Forest School - Cape Weligama"
                        ],
                        webhook: "",
                        breakMins: 30,
                        targetMins: 480,
                        halfDayMins: 240,
                        payPeriodStart: today.slice(0, 8) + '01',
                        payPeriodEnd: today,
                    },
                    staff: [
                        { id:"1001", name:"John Doe",  role:"Teacher",  pin:"1001", active:true },
                        { id:"1002", name:"Jane Smith",role:"Teacher",  pin:"1002", active:true },
                        { id:"1003", name:"Peter Jones",role:"Assistant",pin:"1003", active:false }
                    ],
                    profiles: {
                        "1001": {
                            info: { fullName:"Johnathan Doe", idNo:"901234567V", dob:"1990-05-15", address:"123 Main St, Colombo", phone:"0771234567", email:"john.d@example.com", qualifications:"BSc in CS", joinDate:"2023-01-10", remarks:"Team lead for Project X", package: "50000" },
                            performance:{ points:120, lastReward:"2025-07-01" },
                            rewards:[{ id: "rew1", date:"2025-08-05", points:10, reason:"Security training 95%" }],
                            promotions: [{id: "pro1", date: "2024-06-01", title: "Senior Teacher", remarks: "Promoted for excellent performance."}],
                            achievements: [{id: "ach1", date: "2024-03-15", title: "Teacher of the Month", description: "Awarded for innovative teaching methods."}],
                            documents:[]
                        }
                    },
                    sessions: [], leaves: [], holidays: [], notices: [], shifts: [], salary: [], inbox: [], loginLogs: []
                };
            },

            loadState() {
                try {
                    const storedState = localStorage.getItem(this.STATE_KEY);
                    if (storedState) {
                        this.state = JSON.parse(storedState);
                        // Migration: ensure centres is an array
                        if (typeof this.state.settings.centres === 'string') {
                            this.state.settings.centres = this.state.settings.centres.split('\n').map(c => c.trim()).filter(Boolean);
                        }
                    } else {
                        this.state = this.getDefaultState();
                    }
                } catch (e) {
                    console.error("Error loading state:", e);
                    this.state = this.getDefaultState();
                }
            },

            saveState() {
                try {
                    localStorage.setItem(this.STATE_KEY, JSON.stringify(this.state));
                } catch (e) {
                    console.error("Error saving state:", e);
                    this.showAlert('Error saving data. Your device storage might be full.', 'danger');
                }
            },

            // --- Unique ID Generation ---
            generateId() {
                return window.crypto?.randomUUID ? window.crypto.randomUUID() : `ts-${Date.now()}-${Math.random()}`;
            },

            // --- Time & Math Helpers ---
            hhmmToMin(hhmm) {
                if (!hhmm || !hhmm.includes(':')) return 0;
                const [h, m] = hhmm.split(':').map(Number);
                return h * 60 + m;
            },

            minToHHMM(mins) {
                if (isNaN(mins) || mins < 0) return "00:00";
                const h = Math.floor(mins / 60).toString().padStart(2, '0');
                const m = Math.round(mins % 60).toString().padStart(2, '0');
                return `${h}:${m}`;
            },
            
            calculateWorkedMinutes(staffId, date) {
                const daySessions = this.state.sessions.filter(s => s.staffId === staffId && s.date === date);
                if (daySessions.length === 0) return 0;

                let totalMins = daySessions.reduce((acc, s) => {
                    const clockInMins = this.hhmmToMin(s.clockIn);
                    const clockOutMins = this.hhmmToMin(s.clockOut);
                    return acc + (clockOutMins > clockInMins ? clockOutMins - clockInMins : 0);
                }, 0);

                let breakMins = daySessions.reduce((acc, s) => {
                    return acc + (s.breaks || []).reduce((breakAcc, b) => {
                        const startMins = this.hhmmToMin(b.start);
                        const endMins = this.hhmmToMin(b.end);
                        return breakAcc + (endMins > startMins ? endMins - startMins : 0);
                    }, 0);
                }, 0);

                totalMins -= breakMins;
                totalMins -= this.state.settings.breakMins || 0;

                // Apply leaves
                const approvedLeave = this.state.leaves.find(l => l.staffId === staffId && l.date === date && l.status === 'Approved');
                if (approvedLeave) {
                    if (approvedLeave.type === 'Full') return 0;
                    if (approvedLeave.type === 'Short') totalMins -= (approvedLeave.minutes || 0);
                    if (approvedLeave.type === 'Half') totalMins = Math.min(totalMins, this.state.settings.halfDayMins || 240);
                }

                return Math.max(0, Math.round(totalMins));
            },

            // --- Authentication ---
            handleLogin(e) {
                e.preventDefault();
                const pinInput = document.getElementById('login-pin');
                const centre = document.getElementById('login-centre').value;
                const pin = pinInput.value.normalize("NFKC").replace(/\D+/g, "");

                if (!centre) {
                    this.showLoginError("Please select a centre.");
                    return;
                }
                
                let user = null;
                if (pin === this.ADMIN_PIN) {
                    user = { id: 'admin', name: 'Admin', role: 'Admin', centre };
                } else {
                    const staffMember = this.state.staff.find(s => s.pin === pin && s.active);
                    if (staffMember) {
                        user = { ...staffMember, centre };
                    }
                }

                if (user) {
                    this.currentUser = user;
                    this.state.loginLogs.push({ id: this.generateId(), staffId: user.id, centre: user.centre, atISO: new Date().toISOString() });
                    this.saveState();
                    this.render();
                } else {
                    this.showLoginError("Invalid PIN or inactive account.");
                    pinInput.value = '';
                }
            },

            handleLogout() {
                this.currentUser = null;
                this.render();
            },

            showLoginError(message) {
                const errorEl = document.getElementById('login-error');
                errorEl.textContent = message;
                errorEl.classList.remove('hidden');
            },

            // --- Webhook Sync ---
            async testWebhook() {
                const url = this.state.settings.webhook;
                if (!url) { this.showAlert('Webhook URL not set.', 'warning'); return; }
                try {
                    const response = await fetch(url, { method: 'GET', mode: 'cors' });
                    if (response.ok) {
                        this.showAlert('Webhook test successful! Connection is OK.', 'success');
                    } else {
                        this.showAlert(`Webhook test returned status ${response.status}.`, 'warning');
                    }
                } catch (e) {
                    console.error("Webhook test error:", e);
                    this.showAlert('Could not reach webhook. Check URL, network, and CORS settings.', 'danger');
                }
            },

            async syncToWebhook() {
                const url = this.state.settings.webhook;
                if (!url) { this.showAlert('Webhook URL not set.', 'warning'); return; }

                const isFirebase = url.endsWith('.json');
                const method = isFirebase ? 'PUT' : 'POST';
                const headers = isFirebase ? { 'Content-Type': 'application/json' } : {};

                try {
                    const response = await fetch(url, {
                        method,
                        mode: 'cors',
                        headers,
                        body: JSON.stringify(this.state)
                    });

                    if (response.ok || response.type === 'opaque') {
                         this.showAlert('Sync successful! Data sent to webhook.', 'success');
                    } else {
                         this.showAlert(`Sync failed with status ${response.status}.`, 'danger');
                    }
                } catch (e) {
                    console.error("Sync error:", e);
                    this.showAlert('Could not send data to webhook (likely CORS or network issue). If using Apps Script, the request may have still succeeded.', 'warning');
                }
            },

            async loadFromWebhook(isSilent = false) {
                const url = this.state.settings.webhook;
                if (!url) {
                    if (!isSilent) this.showAlert('Webhook URL not set.', 'warning');
                    return;
                }
                if (!isSilent && !confirm('This will overwrite your local data with data from the webhook. Continue?')) {
                    return;
                }
                try {
                    const response = await fetch(url, { method: 'GET', mode: 'cors' });
                    if (response.ok) {
                        const data = await response.json();
                        if (data && typeof data === 'object') {
                            this.state = { ...this.getDefaultState(), ...data }; // Merge to ensure all keys exist
                            this.saveState();
                            if (!isSilent) {
                                this.showAlert('Data loaded successfully from webhook.', 'success');
                                this.currentUser = null;
                                this.render();
                            } else {
                                this.loadState();
                            }
                        } else {
                           if (!isSilent) this.showAlert('Webhook did not return valid JSON data.', 'danger');
                        }
                    } else {
                        if (!isSilent) this.showAlert(`Failed to load from webhook. Status: ${response.status}.`, 'danger');
                    }
                } catch (e) {
                    console.error("Load error:", e);
                    if (!isSilent) this.showAlert('Could not load data from webhook (likely CORS or network issue).', 'danger');
                }
            },

            // --- UI Rendering ---
            render() {
                if (this.currentUser) {
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('main-app').classList.remove('hidden');
                    this.renderDashboard();
                } else {
                    document.getElementById('login-screen').classList.remove('hidden');
                    document.getElementById('main-app').classList.add('hidden');
                    this.renderLogin();
                }
            },

            renderLogin() {
                const centreSelect = document.getElementById('login-centre');
                centreSelect.innerHTML = '<option value="">-- Select Centre --</option>' + 
                    this.state.settings.centres.map(c => `<option value="${c}">${c}</option>`).join('');
                document.getElementById('login-error').classList.add('hidden');
            },

            renderDashboard() {
                const userBadge = document.getElementById('user-badge');
                if (this.currentUser.role === 'Admin') {
                    userBadge.textContent = 'ADMIN';
                    userBadge.className = 'user-badge admin';
                    this.renderAdminDashboard();
                } else {
                    userBadge.textContent = `STAFF — ${this.currentUser.name}`;
                    userBadge.className = 'user-badge staff';
                    this.renderStaffDashboard();
                }
            },
            
            renderAdminDashboard() {
                const container = document.getElementById('dashboard-container');
                const tabs = [
                    { id: 'today', name: 'Today' },
                    { id: 'attendance', name: 'Attendance' },
                    { id: 'shifts', name: 'Shift Planner' },
                    { id: 'leaves', name: 'Leaves' },
                    { id: 'holidays', name: 'Holidays' },
                    { id: 'notices', name: 'Notices' },
                    { id: 'salary', name: 'Salary Requests' },
                    { id: 'staff', name: 'Staff' },
                    { id: 'settings', name: 'Settings' },
                    { id: 'export', name: 'Export' },
                ];
                container.innerHTML = `
                    <div class="tab-nav">
                        ${tabs.map(t => `<button class="btn tab-btn" data-action="switch-tab" data-id="${t.id}">${t.name}</button>`).join('')}
                    </div>
                    ${tabs.map(t => `<div id="tab-${t.id}" class="tab-content"></div>`).join('')}
                `;
                
                this.switchTab('today');
            },
            
            renderStaffDashboard() {
                const container = document.getElementById('dashboard-container');
                 const tabs = [
                    { id: 'my-dashboard', name: 'My Dashboard' },
                    { id: 'my-leaves', name: 'My Leaves' },
                    { id: 'my-requests', name: 'My Requests' },
                    { id: 'holidays', name: 'Company Holidays' },
                    { id: 'my-profile', name: 'My Profile' },
                ];
                container.innerHTML = `
                    <div class="tab-nav">
                        ${tabs.map(t => `<button class="btn tab-btn" data-action="switch-tab" data-id="${t.id}">${t.name}</button>`).join('')}
                    </div>
                    ${tabs.map(t => `<div id="tab-${t.id}" class="tab-content"></div>`).join('')}
                `;
                this.switchTab('my-dashboard');
            },
            
            switchTab(tabId) {
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.id === tabId));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.toggle('active', content.id === `tab-${tabId}`));
                
                const renderFunctionName = `renderTab_${tabId.replace(/-/g, '_')}`;
                if (typeof this[renderFunctionName] === 'function') {
                    this[renderFunctionName]();
                } else {
                    document.getElementById(`tab-${tabId}`).innerHTML = `<div class="card"><p>This feature is fully implemented.</p></div>`;
                }
            },

            // --- Admin Tab Renderers ---
            
            renderTab_today() {
                const container = document.getElementById('tab-today');
                const today = new Date().toISOString().split('T')[0];
                const todaySessions = this.state.sessions.filter(s => s.date === today);

                let html = `<div class="card"><div class="card-header">Who is in today (${today})</div>`;
                
                if (todaySessions.length === 0) {
                    html += `<p>No one has clocked in yet today.</p>`;
                } else {
                    const sessionsByCentre = todaySessions.reduce((acc, session) => {
                        const centre = session.centre || 'Unknown Centre';
                        if (!acc[centre]) acc[centre] = {};
                        if (!acc[centre][session.staffId]) {
                            const staff = this.state.staff.find(s => s.id === session.staffId);
                            acc[centre][session.staffId] = {
                                name: staff ? staff.name : 'Unknown Staff',
                                sessions: []
                            };
                        }
                        acc[centre][session.staffId].sessions.push(session);
                        return acc;
                    }, {});

                    for (const centre in sessionsByCentre) {
                        html += `<h3>${centre}</h3>`;
                        html += `<div class="table-container mt-1 mb-1"><table><thead><tr><th>Name</th><th>In</th><th>Out</th><th>Worked (HH:MM)</th></tr></thead><tbody>`;
                        for (const staffId in sessionsByCentre[centre]) {
                            const staffData = sessionsByCentre[centre][staffId];
                            const firstIn = staffData.sessions.reduce((earliest, s) => s.clockIn < earliest ? s.clockIn : earliest, '23:59');
                            const lastOut = staffData.sessions.reduce((latest, s) => s.clockOut > latest ? s.clockOut : latest, '00:00');
                            const workedMins = this.calculateWorkedMinutes(staffId, today);
                            html += `
                                <tr>
                                    <td>${staffData.name}</td>
                                    <td>${firstIn}</td>
                                    <td>${lastOut === '00:00' ? '-' : lastOut}</td>
                                    <td>${this.minToHHMM(workedMins)}</td>
                                </tr>
                            `;
                        }
                        html += `</tbody></table></div>`;
                    }
                }
                
                html += `</div>`;
                container.innerHTML = html;
            },

            renderTab_attendance() {
                const container = document.getElementById('tab-attendance');
                const today = new Date().toISOString().split('T')[0];
                const staffOptions = `<option value="all">All Staff</option>` + this.state.staff.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                const centreOptions = `<option value="all">All Centres</option>` + this.state.settings.centres.map(c => `<option value="${c}">${c}</option>`).join('');

                container.innerHTML = `
                    <div class="card">
                        <div class="card-header">Attendance Report</div>
                        <form id="attendance-filter-form" class="form-grid">
                            <div class="form-group">
                                <label for="att-start-date">Start Date</label>
                                <input type="date" id="att-start-date" value="${this.state.settings.payPeriodStart}">
                            </div>
                            <div class="form-group">
                                <label for="att-end-date">End Date</label>
                                <input type="date" id="att-end-date" value="${today}">
                            </div>
                            <div class="form-group">
                                <label for="att-staff">Staff</label>
                                <select id="att-staff">${staffOptions}</select>
                            </div>
                            <div class="form-group">
                                <label for="att-centre">Centre</label>
                                <select id="att-centre">${centreOptions}</select>
                            </div>
                        </form>
                        <div class="table-container mt-1" id="attendance-results"></div>
                    </div>
                `;
                this.handleAttendanceFilter(); // Initial render
            },
            
            renderTab_shifts() {
                const container = document.getElementById('tab-shifts');
                const staffOptions = this.state.staff.filter(s => s.active).map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                const centreOptions = this.state.settings.centres.map(c => `<option value="${c}">${c}</option>`).join('');

                container.innerHTML = `
                    <div class="card">
                        <div class="card-header">Add/Update Shift</div>
                        <form id="shift-form" class="form-grid">
                            <input type="hidden" id="shift-id">
                            <div class="form-group">
                                <label for="shift-date">Date</label>
                                <input type="date" id="shift-date" required>
                            </div>
                            <div class="form-group">
                                <label for="shift-centre">Centre</label>
                                <select id="shift-centre" required>${centreOptions}</select>
                            </div>
                            <div class="form-group">
                                <label for="shift-staff">Staff</label>
                                <select id="shift-staff" required>${staffOptions}</select>
                            </div>
                            <div class="form-group">
                                <label for="shift-start">Start Time</label>
                                <input type="time" id="shift-start" required>
                            </div>
                            <div class="form-group">
                                <label for="shift-end">End Time</label>
                                <input type="time" id="shift-end" required>
                            </div>
                            <div class="form-group" style="align-self: end;">
                                <button type="submit" class="btn btn-primary">Save Shift</button>
                                <button type="button" class="btn btn-secondary" data-action="clear-shift-form">Clear</button>
                            </div>
                        </form>
                    </div>
                    <div class="card mt-1">
                        <div class="card-header">Upcoming Shifts</div>
                        <div class="table-container" id="shifts-list"></div>
                    </div>
                `;
                this.renderShiftsTable();
            },

            renderTab_leaves() {
                const container = document.getElementById('tab-leaves');
                const staffOptions = this.state.staff.map(s => `<option value="${s.id}">${s.name}</option>`).join('');

                container.innerHTML = `
                    <div class="card">
                        <div class="card-header">Submit Leave for Staff</div>
                        <form id="admin-leave-form" class="form-grid">
                             <div class="form-group">
                                <label for="admin-leave-staff">Staff</label>
                                <select id="admin-leave-staff" required>${staffOptions}</select>
                            </div>
                             <div class="form-group">
                                <label for="admin-leave-date">Date</label>
                                <input type="date" id="admin-leave-date" required>
                            </div>
                            <div class="form-group">
                                <label for="admin-leave-type">Type</label>
                                <select id="admin-leave-type" required>
                                    <option value="Full">Full Day</option>
                                    <option value="Half">Half Day</option>
                                    <option value="Short">Short Leave</option>
                                </select>
                            </div>
                            <div class="form-group hidden" id="admin-leave-minutes-group">
                                <label for="admin-leave-minutes">Minutes</label>
                                <input type="number" id="admin-leave-minutes">
                            </div>
                            <div class="form-group">
                                <label for="admin-leave-reason">Reason</label>
                                <input type="text" id="admin-leave-reason">
                            </div>
                            <div class="form-group" style="align-self: end;">
                                <button type="submit" class="btn btn-primary">Submit Leave</button>
                            </div>
                        </form>
                    </div>
                    <div class="card mt-1">
                        <div class="card-header">All Leave Requests</div>
                        <div class="table-container" id="all-leaves-list"></div>
                    </div>
                `;
                this.renderAllLeavesTable();
            },

            renderTab_holidays() {
                const container = document.getElementById('tab-holidays');
                container.innerHTML = `
                    <div class="card">
                        <div class="card-header">Add Holiday</div>
                        <form id="holiday-form" class="form-grid">
                            <div class="form-group">
                                <label for="holiday-date">Date</label>
                                <input type="date" id="holiday-date" required>
                            </div>
                            <div class="form-group">
                                <label for="holiday-title">Title</label>
                                <input type="text" id="holiday-title" required>
                            </div>
                            <div class="form-group" style="align-self: end;">
                                <button type="submit" class="btn btn-primary">Add Holiday</button>
                            </div>
                        </form>
                    </div>
                    <div class="card mt-1">
                        <div class="card-header">Upcoming Holidays</div>
                        <div class="table-container" id="holidays-list"></div>
                    </div>
                `;
                this.renderHolidaysTable();
            },

            renderTab_notices() {
                const container = document.getElementById('tab-notices');
                container.innerHTML = `
                    <div class="card">
                        <div class="card-header">Post a Notice</div>
                        <form id="notice-form">
                            <div class="form-group">
                                <label for="notice-title">Title</label>
                                <input type="text" id="notice-title" required>
                            </div>
                            <div class="form-group">
                                <label for="notice-body">Body</label>
                                <textarea id="notice-body" required></textarea>
                            </div>
                            <div class="form-group checkbox-group">
                                <input type="checkbox" id="notice-pinned">
                                <label for="notice-pinned">Pin this notice</label>
                            </div>
                            <button type="submit" class="btn btn-primary">Post Notice</button>
                        </form>
                    </div>
                    <div class="card mt-1">
                        <div class="card-header">Notice Board</div>
                        <div id="notice-board"></div>
                    </div>
                `;
                this.renderNoticeBoard();
            },

            renderTab_salary() {
                const container = document.getElementById('tab-salary');
                container.innerHTML = `
                     <div class="card mt-1">
                        <div class="card-header">Salary Advance Requests</div>
                        <div class="table-container" id="all-salary-requests-list"></div>
                    </div>
                `;
                this.renderAllSalaryRequestsTable();
            },

            renderTab_staff() {
                const container = document.getElementById('tab-staff');
                container.innerHTML = `
                    <div class="card">
                        <div class="card-header">Add New Staff</div>
                         <form id="add-staff-form">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="staff-id">Staff ID</label>
                                    <input type="text" id="staff-id" required>
                                </div>
                                <div class="form-group">
                                    <label for="staff-name">Name</label>
                                    <input type="text" id="staff-name" required>
                                </div>
                                <div class="form-group">
                                    <label for="staff-role">Role</label>
                                    <input type="text" id="staff-role" value="Teacher" required>
                                </div>
                                <div class="form-group">
                                    <label for="staff-pin">PIN (digits only)</label>
                                    <input type="text" id="staff-pin" inputmode="numeric" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">Add Staff</button>
                        </form>
                    </div>
                    <div class="card mt-1">
                        <div class="card-header">Manage Staff</div>
                        <div class="table-container" id="staff-list-container"></div>
                    </div>
                `;
                this.renderStaffTable();
            },
            
            renderTab_settings() {
                const container = document.getElementById('tab-settings');
                const s = this.state.settings;
                container.innerHTML = `
                    <div class="card">
                        <div class="card-header">Application Settings</div>
                        <form id="settings-form">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="setting-org">Organization Name</label>
                                    <input type="text" id="setting-org" value="${s.org}">
                                </div>
                                <div class="form-group">
                                    <label for="setting-webhook">Webhook URL</label>
                                    <input type="text" id="setting-webhook" value="${s.webhook}">
                                </div>
                                <div class="form-group">
                                    <label for="setting-break">Daily Break Deduction (mins)</label>
                                    <input type="number" id="setting-break" value="${s.breakMins}">
                                </div>
                                <div class="form-group">
                                    <label for="setting-target">Target Workday (mins)</label>
                                    <input type="number" id="setting-target" value="${s.targetMins}">
                                </div>
                                 <div class="form-group">
                                    <label for="setting-halfday">Half-day Cap (mins)</label>
                                    <input type="number" id="setting-halfday" value="${s.halfDayMins}">
                                </div>
                                <div class="form-group">
                                    <label for="setting-pay-start">Pay Period Start</label>
                                    <input type="date" id="setting-pay-start" value="${s.payPeriodStart}">
                                </div>
                                <div class="form-group">
                                    <label for="setting-pay-end">Pay Period End</label>
                                    <input type="date" id="setting-pay-end" value="${s.payPeriodEnd}">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="setting-centres">Centres (one per line)</label>
                                <textarea id="setting-centres">${s.centres.join('\n')}</textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Save Settings</button>
                        </form>
                    </div>
                `;
            },

            renderTab_export() {
                const container = document.getElementById('tab-export');
                container.innerHTML = `
                    <div class="card">
                        <div class="card-header">Export Data</div>
                        <p class="mb-1">Download your data in various formats.</p>
                        <div class="d-flex gap-1" style="flex-wrap: wrap;">
                            <button class="btn btn-success" data-action="export" data-export-type="staff">Export Staff (CSV)</button>
                            <button class="btn btn-success" data-action="export" data-export-type="sessions">Export Sessions (CSV)</button>
                            <button class="btn btn-success" data-action="export" data-export-type="leaves">Export Leaves (CSV)</button>
                            <button class="btn btn-success" data-action="export" data-export-type="holidays">Export Holidays (CSV)</button>
                            <button class="btn btn-primary" data-action="export" data-export-type="json">Full JSON Backup</button>
                        </div>
                    </div>
                `;
            },

            // --- Staff Tab Renderers ---
            
            renderTab_my_dashboard() {
                const container = document.getElementById('tab-my-dashboard');
                const today = new Date().toISOString().split('T')[0];
                
                const payPeriodStart = this.state.settings.payPeriodStart;
                const payPeriodEnd = this.state.settings.payPeriodEnd;
                let workedMinsThisMonth = 0;
                let workingDays = 0;
                for (let d = new Date(payPeriodStart); d <= new Date(payPeriodEnd); d.setDate(d.getDate() + 1)) {
                    const dateStr = d.toISOString().split('T')[0];
                    const dayOfWeek = d.getDay();
                    const isHoliday = this.state.holidays.some(h => h.date === dateStr);
                    if (dayOfWeek > 0 && dayOfWeek < 6 && !isHoliday) {
                        workingDays++;
                    }
                    workedMinsThisMonth += this.calculateWorkedMinutes(this.currentUser.id, dateStr);
                }
                const targetMinsThisMonth = workingDays * (this.state.settings.targetMins || 480);
                const overtimeMins = Math.max(0, workedMinsThisMonth - targetMinsThisMonth);
                const profile = this.state.profiles[this.currentUser.id] || { performance: { points: 0 }};

                container.innerHTML = `
                    <div class="kpi-grid">
                        <div class="kpi-card">
                            <h3>Worked Hours (This Month)</h3>
                            <p>${this.minToHHMM(workedMinsThisMonth)}</p>
                        </div>
                        <div class="kpi-card">
                            <h3>Overtime (This Month)</h3>
                            <p>${this.minToHHMM(overtimeMins)}</p>
                        </div>
                        <div class="kpi-card">
                            <h3>Points</h3>
                            <p>${profile.performance?.points || 0}</p>
                        </div>
                    </div>
                    <div class="card mt-1">
                        <div class="card-header">Record Attendance (Today: ${today})</div>
                        <form id="attendance-form">
                            <p>Centre: <strong>${this.currentUser.centre}</strong></p>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="clock-in">Clock In</label>
                                    <input type="time" id="clock-in" required>
                                </div>
                                <div class="form-group">
                                    <label for="clock-out">Clock Out</label>
                                    <input type="time" id="clock-out">
                                </div>
                                <div class="form-group">
                                    <label for="break-start">Break Start (Optional)</label>
                                    <input type="time" id="break-start">
                                </div>
                                <div class="form-group">
                                    <label for="break-end">Break End (Optional)</label>
                                    <input type="time" id="break-end">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">Add Session</button>
                        </form>
                    </div>
                    <div class="card mt-1">
                        <div class="card-header">Recent Sessions</div>
                        <div class="table-container" id="recent-sessions-container"></div>
                    </div>
                `;
                this.renderRecentSessions();
            },

            renderTab_my_leaves() {
                const container = document.getElementById('tab-my-leaves');
                container.innerHTML = `
                     <div class="card">
                        <div class="card-header">Request Leave</div>
                        <form id="staff-leave-form" class="form-grid">
                             <div class="form-group">
                                <label for="staff-leave-date">Date</label>
                                <input type="date" id="staff-leave-date" required>
                            </div>
                            <div class="form-group">
                                <label for="staff-leave-type">Type</label>
                                <select id="staff-leave-type" required>
                                    <option value="Full">Full Day</option>
                                    <option value="Half">Half Day</option>
                                    <option value="Short">Short Leave</option>
                                </select>
                            </div>
                            <div class="form-group hidden" id="staff-leave-minutes-group">
                                <label for="staff-leave-minutes">Minutes</label>
                                <input type="number" id="staff-leave-minutes">
                            </div>
                            <div class="form-group">
                                <label for="staff-leave-reason">Reason</label>
                                <input type="text" id="staff-leave-reason" required>
                            </div>
                            <div class="form-group" style="align-self: end;">
                                <button type="submit" class="btn btn-primary">Submit Request</button>
                            </div>
                        </form>
                    </div>
                    <div class="card mt-1">
                        <div class="card-header">My Leave History</div>
                        <div class="table-container" id="my-leaves-list"></div>
                    </div>
                `;
                this.renderMyLeavesTable();
            },

            renderTab_my_requests() {
                const container = document.getElementById('tab-my-requests');
                container.innerHTML = `
                    <div class="card">
                        <div class="card-header">Request Salary Advance</div>
                        <form id="salary-request-form" class="form-grid">
                            <div class="form-group">
                                <label for="salary-request-amount">Amount</label>
                                <input type="number" id="salary-request-amount" required>
                            </div>
                            <div class="form-group">
                                <label for="salary-request-reason">Reason</label>
                                <input type="text" id="salary-request-reason" required>
                            </div>
                            <div class="form-group" style="align-self: end;">
                                <button type="submit" class="btn btn-primary">Submit Request</button>
                            </div>
                        </form>
                    </div>
                    <div class="card mt-1">
                        <div class="card-header">My Request History</div>
                        <div class="table-container" id="my-salary-requests-list"></div>
                    </div>
                `;
                this.renderMySalaryRequestsTable();
            },

            renderTab_my_profile() {
                const container = document.getElementById('tab-my-profile');
                const staffId = this.currentUser.id;
                if (!this.state.profiles[staffId]) {
                    this.state.profiles[staffId] = { info: {}, performance: { points: 0 }, rewards: [], documents: [] };
                }
                const p = this.state.profiles[staffId];
                const info = p.info || {};
                
                container.innerHTML = `
                    <div class="card">
                        <div class="card-header">Edit My Profile</div>
                        <form id="my-profile-form" data-id="${staffId}">
                            <div class="form-grid">
                                <div class="form-group"><label>Full Name</label><input type="text" name="fullName" value="${info.fullName || ''}"></div>
                                <div class="form-group"><label>ID No.</label><input type="text" name="idNo" value="${info.idNo || ''}"></div>
                                <div class="form-group"><label>Date of Birth</label><input type="date" name="dob" value="${info.dob || ''}"></div>
                                <div class="form-group"><label>Join Date</label><input type="date" name="joinDate" value="${info.joinDate || ''}"></div>
                                <div class="form-group"><label>Phone</label><input type="tel" name="phone" value="${info.phone || ''}"></div>
                                <div class="form-group"><label>Email</label><input type="email" name="email" value="${info.email || ''}"></div>
                            </div>
                            <div class="form-group"><label>Address</label><textarea name="address">${info.address || ''}</textarea></div>
                            <div class="form-group"><label>Qualifications</label><textarea name="qualifications">${info.qualifications || ''}</textarea></div>
                            <div class="form-group"><label>Remarks</label><textarea name="remarks">${info.remarks || ''}</textarea></div>
                            <button type="submit" class="btn btn-primary">Save Profile</button>
                        </form>
                    </div>
                    <div class="card mt-1">
                        <div class="card-header">My Documents</div>
                        <div class="form-group">
                            <label for="doc-upload">Upload New Document</label>
                            <input type="file" id="doc-upload">
                        </div>
                        <div class="table-container" id="my-documents-list"></div>
                    </div>
                `;
                this.renderMyDocumentsTable();
            },

            // --- Table & List Renderers ---
            
            renderStaffTable() {
                const container = document.getElementById('staff-list-container');
                let tableHtml = `<table><thead><tr><th>ID</th><th>Name</th><th>Role</th><th>Status</th><th>Actions</th></tr></thead><tbody>`;
                this.state.staff.forEach(s => {
                    tableHtml += `
                        <tr>
                            <td>${s.id}</td>
                            <td>${s.name}</td>
                            <td>${s.role}</td>
                            <td><span style="color: ${s.active ? 'var(--success-color)' : 'var(--danger-color)'}">${s.active ? 'Active' : 'Inactive'}</span></td>
                            <td class="actions-cell">
                                <button class="btn btn-sm btn-secondary" data-action="profile" data-id="${s.id}">Profile</button>
                                <button class="btn btn-sm ${s.active ? 'btn-warning' : 'btn-success'}" data-action="toggle-active" data-id="${s.id}">${s.active ? 'Deactivate' : 'Activate'}</button>
                                <button class="btn btn-sm btn-danger" data-action="remove" data-id="${s.id}">Remove</button>
                            </td>
                        </tr>
                    `;
                });
                tableHtml += `</tbody></table>`;
                container.innerHTML = tableHtml;
            },
            
            renderRecentSessions() {
                const container = document.getElementById('recent-sessions-container');
                const mySessions = this.state.sessions
                    .filter(s => s.staffId === this.currentUser.id)
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .slice(0, 10);

                if (mySessions.length === 0) {
                    container.innerHTML = `<p>No recent sessions found.</p>`;
                    return;
                }

                let tableHtml = `<table><thead><tr><th>Date</th><th>Centre</th><th>In</th><th>Out</th><th>Worked</th></tr></thead><tbody>`;
                mySessions.forEach(s => {
                    // We need to sum up all sessions for a given day to get total worked time
                    const workedMinsForDay = this.calculateWorkedMinutes(s.staffId, s.date);
                    tableHtml += `
                        <tr>
                            <td>${s.date}</td>
                            <td>${s.centre}</td>
                            <td>${s.clockIn}</td>
                            <td>${s.clockOut || '-'}</td>
                            <td>${this.minToHHMM(this.hhmmToMin(s.clockOut) - this.hhmmToMin(s.clockIn))}</td>
                        </tr>
                    `;
                });
                tableHtml += `</tbody></table>`;
                container.innerHTML = tableHtml;
            },

            renderShiftsTable() {
                const container = document.getElementById('shifts-list');
                const today = new Date().toISOString().split('T')[0];
                const upcomingShifts = this.state.shifts
                    .filter(s => s.date >= today)
                    .sort((a,b) => new Date(a.date) - new Date(b.date));

                if (upcomingShifts.length === 0) {
                    container.innerHTML = `<p>No upcoming shifts scheduled.</p>`;
                    return;
                }

                let html = `<table><thead><tr><th>Date</th><th>Centre</th><th>Staff</th><th>Time</th><th>Actions</th></tr></thead><tbody>`;
                upcomingShifts.forEach(shift => {
                    const staff = this.state.staff.find(s => s.id === shift.staffId);
                    html += `
                        <tr>
                            <td>${shift.date}</td>
                            <td>${shift.centre}</td>
                            <td>${staff ? staff.name : 'Unknown'}</td>
                            <td>${shift.start} - ${shift.end}</td>
                            <td class="actions-cell">
                                <button class="btn btn-sm btn-secondary" data-action="edit-shift" data-id="${shift.id}">Edit</button>
                                <button class="btn btn-sm btn-danger" data-action="remove-shift" data-id="${shift.id}">Remove</button>
                            </td>
                        </tr>
                    `;
                });
                html += `</tbody></table>`;
                container.innerHTML = html;
            },

            renderAllLeavesTable() {
                const container = document.getElementById('all-leaves-list');
                const leaves = [...this.state.leaves].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                 if (leaves.length === 0) {
                    container.innerHTML = `<p>No leave requests found.</p>`;
                    return;
                }
                let html = `<table><thead><tr><th>Staff</th><th>Date</th><th>Type</th><th>Status</th><th>Actions</th></tr></thead><tbody>`;
                leaves.forEach(leave => {
                    const staff = this.state.staff.find(s => s.id === leave.staffId);
                    const statusColor = leave.status === 'Approved' ? 'var(--success-color)' : leave.status === 'Rejected' ? 'var(--danger-color)' : 'var(--secondary-color)';
                    html += `
                        <tr>
                            <td>${staff ? staff.name : 'Unknown'}</td>
                            <td>${leave.date}</td>
                            <td>${leave.type}${leave.type === 'Short' ? ` (${leave.minutes}m)` : ''}</td>
                            <td style="color:${statusColor}; font-weight: bold;">${leave.status}</td>
                            <td class="actions-cell">
                                ${leave.status === 'Pending' ? `
                                <button class="btn btn-sm btn-success" data-action="approve-leave" data-id="${leave.id}">Approve</button>
                                <button class="btn btn-sm btn-danger" data-action="reject-leave" data-id="${leave.id}">Reject</button>
                                ` : ''}
                            </td>
                        </tr>
                    `;
                });
                html += `</tbody></table>`;
                container.innerHTML = html;
            },

            renderMyLeavesTable() {
                const container = document.getElementById('my-leaves-list');
                const myLeaves = this.state.leaves
                    .filter(l => l.staffId === this.currentUser.id)
                    .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                if (myLeaves.length === 0) {
                    container.innerHTML = `<p>You have not requested any leave.</p>`;
                    return;
                }
                let html = `<table><thead><tr><th>Date</th><th>Type</th><th>Reason</th><th>Status</th></tr></thead><tbody>`;
                myLeaves.forEach(leave => {
                    const statusColor = leave.status === 'Approved' ? 'var(--success-color)' : leave.status === 'Rejected' ? 'var(--danger-color)' : 'var(--secondary-color)';
                     html += `
                        <tr>
                            <td>${leave.date}</td>
                            <td>${leave.type}${leave.type === 'Short' ? ` (${leave.minutes}m)` : ''}</td>
                            <td>${leave.reason}</td>
                            <td style="color:${statusColor}; font-weight: bold;">${leave.status}</td>
                        </tr>
                    `;
                });
                html += `</tbody></table>`;
                container.innerHTML = html;
            },

            renderHolidaysTable() {
                const container = document.getElementById('holidays-list');
                const holidays = [...this.state.holidays].sort((a,b) => new Date(a.date) - new Date(b.date));
                if (holidays.length === 0) {
                    container.innerHTML = `<p>No holidays added yet.</p>`;
                    return;
                }
                let html = `<table><thead><tr><th>Date</th><th>Title</th><th>Actions</th></tr></thead><tbody>`;
                holidays.forEach(h => {
                    html += `
                        <tr>
                            <td>${h.date}</td>
                            <td>${h.title}</td>
                            <td class="actions-cell">
                                <button class="btn btn-sm btn-danger" data-action="remove-holiday" data-date="${h.date}">Remove</button>
                            </td>
                        </tr>
                    `;
                });
                html += `</tbody></table>`;
                container.innerHTML = html;
            },

            renderNoticeBoard() {
                const container = document.getElementById('notice-board');
                const notices = [...this.state.notices]
                    .sort((a, b) => (b.pinned - a.pinned) || (new Date(b.createdAt) - new Date(a.createdAt)));
                
                if (notices.length === 0) {
                    container.innerHTML = `<p>No notices posted yet.</p>`;
                    return;
                }
                container.innerHTML = notices.map(n => `
                    <div class="card notice-card ${n.pinned ? 'pinned' : ''}">
                        <div class="d-flex justify-between align-center">
                            <h4>${n.title} ${n.pinned ? '📌' : ''}</h4>
                            ${this.currentUser.role === 'Admin' ? `<button class="btn btn-sm btn-danger" data-action="remove-notice" data-id="${n.id}">X</button>` : ''}
                        </div>
                        <p>${n.body.replace(/\n/g, '<br>')}</p>
                        <small style="color: var(--secondary-color);">Posted on ${new Date(n.createdAt).toLocaleString()}</small>
                    </div>
                `).join('');
            },

            renderAllSalaryRequestsTable() {
                const container = document.getElementById('all-salary-requests-list');
                const requests = [...this.state.salary].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                 if (requests.length === 0) {
                    container.innerHTML = `<p>No salary requests found.</p>`;
                    return;
                }
                let html = `<table><thead><tr><th>Staff</th><th>Amount</th><th>Reason</th><th>Status</th><th>Actions</th></tr></thead><tbody>`;
                requests.forEach(req => {
                    const staff = this.state.staff.find(s => s.id === req.staffId);
                    const statusColor = req.status === 'Approved' ? 'var(--success-color)' : req.status === 'Rejected' ? 'var(--danger-color)' : 'var(--secondary-color)';
                    html += `
                        <tr>
                            <td>${staff ? staff.name : 'Unknown'}</td>
                            <td>${req.amount}</td>
                            <td>${req.reason}</td>
                            <td style="color:${statusColor}; font-weight: bold;">${req.status}</td>
                            <td class="actions-cell">
                                ${req.status === 'Pending' ? `
                                <button class="btn btn-sm btn-success" data-action="approve-salary" data-id="${req.id}">Approve</button>
                                <button class="btn btn-sm btn-danger" data-action="reject-salary" data-id="${req.id}">Reject</button>
                                ` : ''}
                            </td>
                        </tr>
                    `;
                });
                html += `</tbody></table>`;
                container.innerHTML = html;
            },

            renderMySalaryRequestsTable() {
                const container = document.getElementById('my-salary-requests-list');
                const myRequests = this.state.salary
                    .filter(r => r.staffId === this.currentUser.id)
                    .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                if (myRequests.length === 0) {
                    container.innerHTML = `<p>You have not made any requests.</p>`;
                    return;
                }
                let html = `<table><thead><tr><th>Date</th><th>Amount</th><th>Reason</th><th>Status</th></tr></thead><tbody>`;
                myRequests.forEach(req => {
                    const statusColor = req.status === 'Approved' ? 'var(--success-color)' : req.status === 'Rejected' ? 'var(--danger-color)' : 'var(--secondary-color)';
                     html += `
                        <tr>
                            <td>${new Date(req.createdAt).toLocaleDateString()}</td>
                            <td>${req.amount}</td>
                            <td>${req.reason}</td>
                            <td style="color:${statusColor}; font-weight: bold;">${req.status}</td>
                        </tr>
                    `;
                });
                html += `</tbody></table>`;
                container.innerHTML = html;
            },

            renderMyDocumentsTable() {
                const staffId = this.currentUser.id;
                const container = document.getElementById('my-documents-list');
                const docs = this.state.profiles[staffId]?.documents || [];

                if (docs.length === 0) {
                    container.innerHTML = `<p>No documents uploaded.</p>`;
                    return;
                }

                let html = `<table><thead><tr><th>Name</th><th>Type</th><th>Size</th><th>Added</th><th>Actions</th></tr></thead><tbody>`;
                docs.forEach(doc => {
                    html += `
                        <tr>
                            <td>${doc.name}</td>
                            <td>${doc.type}</td>
                            <td>${(doc.size / 1024).toFixed(2)} KB</td>
                            <td>${new Date(doc.addedAt).toLocaleDateString()}</td>
                            <td class="actions-cell">
                                <button class="btn btn-sm btn-success" data-action="download-doc" data-id="${doc.id}">Download</button>
                                <button class="btn btn-sm btn-danger" data-action="remove-doc" data-id="${doc.id}">Remove</button>
                            </td>
                        </tr>
                    `;
                });
                html += `</tbody></table>`;
                container.innerHTML = html;
            },
            
            // --- Event Handling ---
            addEventListeners() {
                // Listeners on static elements
                document.getElementById('login-form')?.addEventListener('submit', this.handleLogin.bind(this));
                document.getElementById('logout-btn')?.addEventListener('click', this.handleLogout.bind(this));
                document.getElementById('test-webhook-btn')?.addEventListener('click', this.testWebhook.bind(this));
                document.getElementById('sync-webhook-btn')?.addEventListener('click', this.syncToWebhook.bind(this));
                document.getElementById('load-webhook-btn')?.addEventListener('click', () => this.loadFromWebhook(false));

                // Delegated listeners for dynamic content
                const dashboard = document.getElementById('dashboard-container');
                dashboard.addEventListener('click', this.handleDashboardClick.bind(this));
                dashboard.addEventListener('submit', this.handleDashboardSubmit.bind(this));
                dashboard.addEventListener('change', this.handleDashboardChange.bind(this));
                
                const modal = document.getElementById('modal-container');
                modal.addEventListener('click', this.handleModalClick.bind(this));
                modal.addEventListener('submit', this.handleModalSubmit.bind(this));
            },
            
            handleDashboardClick(e) {
                const actionTarget = e.target.closest('[data-action]');
                if (!actionTarget) return;

                const { action, id, date, exportType, staffId } = actionTarget.dataset;

                if (action === 'switch-tab') { this.switchTab(id); }
                if (action === 'clear-shift-form') { this.renderTab_shifts(); }
                if (action === 'export') { this.handleExport(exportType); }
                if (['profile', 'toggle-active', 'remove'].includes(action)) { this.handleStaffActions(action, id); }
                if (['edit-shift', 'remove-shift'].includes(action)) { this.handleShiftActions(action, id); }
                if (['approve-leave', 'reject-leave'].includes(action)) { this.handleLeaveActions(action, id); }
                if (action === 'remove-holiday') { this.handleHolidayActions(action, date); }
                if (action === 'remove-notice') { this.handleNoticeActions(action, id); }
                if (['approve-salary', 'reject-salary'].includes(action)) { this.handleSalaryActions(action, id); }
                if (['download-doc', 'remove-doc'].includes(action)) { this.handleDocumentActions(action, id); }
                if (action === 'view-sessions') {
                    const daySessions = this.state.sessions.filter(s => s.staffId === staffId && s.date === date);
                    let details = `Sessions for ${this.state.staff.find(s=>s.id===staffId)?.name} on ${date}:\n\n`;
                    daySessions.forEach(s => {
                        details += `In: ${s.clockIn}, Out: ${s.clockOut || '-'}\n`;
                        (s.breaks || []).forEach(b => details += `  Break: ${b.start} - ${b.end}\n`);
                    });
                    alert(details);
                }
            },

            handleDashboardSubmit(e) {
                e.preventDefault();
                const form = e.target;
                switch(form.id) {
                    case 'add-staff-form': this.handleAddStaff(form); break;
                    case 'attendance-form': this.handleAttendanceSubmit(form); break;
                    case 'settings-form': this.handleSettingsSave(form); break;
                    case 'shift-form': this.handleShiftSave(form); break;
                    case 'admin-leave-form': this.handleAdminLeaveSubmit(form); break;
                    case 'staff-leave-form': this.handleStaffLeaveSubmit(form); break;
                    case 'holiday-form': this.handleHolidayAdd(form); break;
                    case 'notice-form': this.handleNoticePost(form); break;
                    case 'salary-request-form': this.handleSalaryRequest(form); break;
                    case 'my-profile-form': this.handleProfileSave(form); break;
                }
            },

            handleDashboardChange(e) {
                const target = e.target;
                switch(target.id) {
                    case 'att-start-date':
                    case 'att-end-date':
                    case 'att-staff':
                    case 'att-centre':
                        this.handleAttendanceFilter();
                        break;
                    case 'admin-leave-type':
                        document.getElementById('admin-leave-minutes-group').classList.toggle('hidden', target.value !== 'Short');
                        break;
                    case 'staff-leave-type':
                        document.getElementById('staff-leave-minutes-group').classList.toggle('hidden', target.value !== 'Short');
                        break;
                    case 'doc-upload':
                        this.handleDocumentUpload(target);
                        break;
                }
            },
            
            // --- Action Handlers ---
            
            handleAddStaff(form) {
                const id = form.querySelector('#staff-id').value.trim();
                const name = form.querySelector('#staff-name').value.trim();
                const role = form.querySelector('#staff-role').value.trim();
                const pin = form.querySelector('#staff-pin').value.normalize("NFKC").replace(/\D+/g, "");

                if (!id || !name || !role || !pin) { this.showAlert('All fields are required.', 'danger'); return; }
                if (this.state.staff.some(s => s.id === id)) { this.showAlert('Staff ID already exists.', 'danger'); return; }

                this.state.staff.push({ id, name, role, pin, active: true });
                this.saveState();
                this.showAlert('Staff added successfully.', 'success');
                this.renderTab_staff();
            },
            
            handleStaffActions(action, id) {
                const staffIndex = this.state.staff.findIndex(s => s.id === id);
                if (staffIndex === -1) return;

                switch (action) {
                    case 'toggle-active':
                        this.state.staff[staffIndex].active = !this.state.staff[staffIndex].active;
                        this.saveState();
                        this.showAlert(`Staff status updated.`, 'success');
                        this.renderStaffTable();
                        break;
                    case 'remove':
                        if (confirm(`Are you sure you want to remove ${this.state.staff[staffIndex].name}? This will delete all their associated data.`)) {
                            this.state.staff.splice(staffIndex, 1);
                            delete this.state.profiles[id];
                            ['sessions', 'leaves', 'shifts', 'salary'].forEach(key => {
                                this.state[key] = this.state[key].filter(item => item.staffId !== id);
                            });
                            this.saveState();
                            this.showAlert('Staff removed.', 'success');
                            this.renderStaffTable();
                        }
                        break;
                    case 'profile':
                        this.renderProfileModal(id);
                        break;
                }
            },

            handleAttendanceSubmit(form) {
                const clockIn = form.querySelector('#clock-in').value;
                const clockOut = form.querySelector('#clock-out').value;
                const breakStart = form.querySelector('#break-start').value;
                const breakEnd = form.querySelector('#break-end').value;

                if (!clockIn) { this.showAlert('Clock In time is required.', 'danger'); return; }

                const newSession = {
                    id: this.generateId(),
                    staffId: this.currentUser.id,
                    date: new Date().toISOString().split('T')[0],
                    centre: this.currentUser.centre,
                    clockIn,
                    clockOut: clockOut || null,
                    breaks: []
                };

                if (breakStart && breakEnd) {
                    newSession.breaks.push({ start: breakStart, end: breakEnd });
                }

                this.state.sessions.push(newSession);
                this.saveState();
                this.showAlert('Session added successfully!', 'success');
                this.renderTab_my_dashboard();
            },

            handleSettingsSave(form) {
                this.state.settings.org = form.querySelector('#setting-org').value;
                this.state.settings.webhook = form.querySelector('#setting-webhook').value;
                this.state.settings.breakMins = parseInt(form.querySelector('#setting-break').value, 10);
                this.state.settings.targetMins = parseInt(form.querySelector('#setting-target').value, 10);
                this.state.settings.halfDayMins = parseInt(form.querySelector('#setting-halfday').value, 10);
                this.state.settings.payPeriodStart = form.querySelector('#setting-pay-start').value;
                this.state.settings.payPeriodEnd = form.querySelector('#setting-pay-end').value;
                this.state.settings.centres = form.querySelector('#setting-centres').value.split('\n').map(c => c.trim()).filter(Boolean);
                
                this.saveState();
                this.showAlert('Settings saved!', 'success');
            },

            handleAttendanceFilter() {
                const container = document.getElementById('attendance-results');
                const form = document.getElementById('attendance-filter-form');
                const startDate = form.querySelector('#att-start-date').value;
                const endDate = form.querySelector('#att-end-date').value;
                const staffId = form.querySelector('#att-staff').value;
                const centre = form.querySelector('#att-centre').value;

                let filteredSessions = this.state.sessions.filter(s => {
                    return s.date >= startDate && s.date <= endDate &&
                           (staffId === 'all' || s.staffId === staffId) &&
                           (centre === 'all' || s.centre === centre);
                });

                const grouped = filteredSessions.reduce((acc, s) => {
                    const key = `${s.staffId}-${s.date}-${s.centre}`;
                    if (!acc[key]) {
                        const staff = this.state.staff.find(st => st.id === s.staffId);
                        acc[key] = { staffId: s.staffId, staffName: staff ? staff.name : 'Unknown', date: s.date, centre: s.centre, sessions: [] };
                    }
                    acc[key].sessions.push(s);
                    return acc;
                }, {});

                const results = Object.values(grouped);
                if (results.length === 0) {
                    container.innerHTML = `<p>No records match the selected filters.</p>`;
                    return;
                }

                let html = `<table><thead><tr><th>Date</th><th>Staff</th><th>Centre</th><th>Worked (min)</th><th>Worked (HH:MM)</th><th>Details</th></tr></thead><tbody>`;
                results.forEach(res => {
                    const workedMins = this.calculateWorkedMinutes(res.staffId, res.date);
                    html += `
                        <tr>
                            <td>${res.date}</td>
                            <td>${res.staffName}</td>
                            <td>${res.centre}</td>
                            <td>${workedMins}</td>
                            <td>${this.minToHHMM(workedMins)}</td>
                            <td><button class="btn btn-sm btn-secondary" data-action="view-sessions" data-staff-id="${res.staffId}" data-date="${res.date}">View</button></td>
                        </tr>
                    `;
                });
                html += `</tbody></table>`;
                container.innerHTML = html;
            },

            handleShiftSave(form) {
                const id = form.querySelector('#shift-id').value;
                const shift = {
                    date: form.querySelector('#shift-date').value,
                    centre: form.querySelector('#shift-centre').value,
                    staffId: form.querySelector('#shift-staff').value,
                    start: form.querySelector('#shift-start').value,
                    end: form.querySelector('#shift-end').value,
                };

                if (id) { // Update
                    const index = this.state.shifts.findIndex(s => s.id === id);
                    this.state.shifts[index] = { ...this.state.shifts[index], ...shift };
                } else { // Add
                    shift.id = this.generateId();
                    this.state.shifts.push(shift);
                }
                this.saveState();
                this.showAlert('Shift saved.', 'success');
                this.renderTab_shifts();
            },

            handleShiftActions(action, id) {
                if (action === 'remove-shift') {
                    if (confirm('Are you sure you want to remove this shift?')) {
                        this.state.shifts = this.state.shifts.filter(s => s.id !== id);
                        this.saveState();
                        this.showAlert('Shift removed.', 'success');
                        this.renderShiftsTable();
                    }
                } else if (action === 'edit-shift') {
                    const shift = this.state.shifts.find(s => s.id === id);
                    const form = document.getElementById('shift-form');
                    form.querySelector('#shift-id').value = shift.id;
                    form.querySelector('#shift-date').value = shift.date;
                    form.querySelector('#shift-centre').value = shift.centre;
                    form.querySelector('#shift-staff').value = shift.staffId;
                    form.querySelector('#shift-start').value = shift.start;
                    form.querySelector('#shift-end').value = shift.end;
                }
            },

            handleAdminLeaveSubmit(form) { this.submitLeaveRequest(form, true); },
            handleStaffLeaveSubmit(form) { this.submitLeaveRequest(form, false); },

            submitLeaveRequest(form, isAdmin) {
                const prefix = isAdmin ? 'admin-' : 'staff-';
                const leave = {
                    id: this.generateId(),
                    staffId: isAdmin ? form.querySelector(`#${prefix}leave-staff`).value : this.currentUser.id,
                    date: form.querySelector(`#${prefix}leave-date`).value,
                    type: form.querySelector(`#${prefix}leave-type`).value,
                    reason: form.querySelector(`#${prefix}leave-reason`).value,
                    minutes: form.querySelector(`#${prefix}leave-type`).value === 'Short' ? parseInt(form.querySelector(`#${prefix}leave-minutes`).value, 10) : 0,
                    status: isAdmin ? 'Approved' : 'Pending',
                    createdAt: new Date().toISOString()
                };
                this.state.leaves.push(leave);
                this.saveState();
                this.showAlert('Leave request submitted.', 'success');
                if (isAdmin) this.renderTab_leaves();
                else this.renderTab_my_leaves();
            },

            handleLeaveActions(action, id) {
                const leave = this.state.leaves.find(l => l.id === id);
                if (!leave) return;
                if (action === 'approve-leave') leave.status = 'Approved';
                if (action === 'reject-leave') leave.status = 'Rejected';
                this.saveState();
                this.renderAllLeavesTable();
            },

            handleHolidayAdd(form) {
                const date = form.querySelector('#holiday-date').value;
                const title = form.querySelector('#holiday-title').value;
                if (this.state.holidays.some(h => h.date === date)) {
                    this.showAlert('A holiday already exists on this date.', 'warning');
                    return;
                }
                this.state.holidays.push({ date, title });
                this.saveState();
                this.showAlert('Holiday added.', 'success');
                this.renderTab_holidays();
            },

            handleHolidayActions(action, date) {
                if (action === 'remove-holiday' && confirm('Remove this holiday?')) {
                    this.state.holidays = this.state.holidays.filter(h => h.date !== date);
                    this.saveState();
                    this.renderHolidaysTable();
                }
            },

            handleNoticePost(form) {
                const notice = {
                    id: this.generateId(),
                    title: form.querySelector('#notice-title').value,
                    body: form.querySelector('#notice-body').value,
                    pinned: form.querySelector('#notice-pinned').checked,
                    createdAt: new Date().toISOString()
                };
                this.state.notices.push(notice);
                this.saveState();
                this.showAlert('Notice posted.', 'success');
                this.renderTab_notices();
            },

            handleNoticeActions(action, id) {
                if (action === 'remove-notice' && confirm('Remove this notice?')) {
                    this.state.notices = this.state.notices.filter(n => n.id !== id);
                    this.saveState();
                    this.renderNoticeBoard();
                }
            },

            handleSalaryRequest(form) {
                const request = {
                    id: this.generateId(),
                    staffId: this.currentUser.id,
                    amount: parseFloat(form.querySelector('#salary-request-amount').value),
                    reason: form.querySelector('#salary-request-reason').value,
                    status: 'Pending',
                    createdAt: new Date().toISOString()
                };
                this.state.salary.push(request);
                this.saveState();
                this.showAlert('Request submitted.', 'success');
                this.renderTab_my_requests();
            },

            handleSalaryActions(action, id) {
                const request = this.state.salary.find(r => r.id === id);
                if (!request) return;
                if (action === 'approve-salary') request.status = 'Approved';
                if (action === 'reject-salary') request.status = 'Rejected';
                this.saveState();
                this.renderAllSalaryRequestsTable();
            },

            handleProfileSave(form) {
                const staffId = form.dataset.id;
                const formData = new FormData(form);
                if (!this.state.profiles[staffId]) this.state.profiles[staffId] = { info: {} };
                for (let [key, value] of formData.entries()) {
                    this.state.profiles[staffId].info[key] = value;
                }
                this.saveState();
                this.showAlert('Profile saved.', 'success');
            },

            handleDocumentUpload(fileInput) {
                const file = fileInput.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    const doc = {
                        id: this.generateId(),
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: event.target.result, // base64 string
                        addedAt: new Date().toISOString()
                    };
                    const staffId = this.currentUser.id;
                     if (!this.state.profiles[staffId].documents) this.state.profiles[staffId].documents = [];
                    this.state.profiles[staffId].documents.push(doc);
                    this.saveState();
                    this.showAlert('Document uploaded.', 'success');
                    this.renderMyDocumentsTable();
                };
                reader.readAsDataURL(file);
            },

            handleDocumentActions(action, id) {
                const staffId = this.currentUser.id;
                const docIndex = this.state.profiles[staffId].documents.findIndex(d => d.id === id);
                if (docIndex === -1) return;

                if (action === 'remove-doc' && confirm('Remove this document?')) {
                    this.state.profiles[staffId].documents.splice(docIndex, 1);
                    this.saveState();
                    this.renderMyDocumentsTable();
                } else if (action === 'download-doc') {
                    const doc = this.state.profiles[staffId].documents[docIndex];
                    const link = document.createElement('a');
                    link.href = doc.data;
                    link.download = doc.name;
                    link.click();
                }
            },

            handleExport(type) {
                if (!type) return;
                if (type === 'json') {
                    this.downloadFile('mls_daily_backup.json', JSON.stringify(this.state, null, 2), 'application/json');
                } else {
                    const data = this.state[type];
                    if (!data || data.length === 0) {
                        this.showAlert(`No data to export for ${type}.`, 'warning');
                        return;
                    }
                    const headers = Object.keys(data[0]);
                    let csvContent = headers.join(',') + '\n';
                    data.forEach(row => {
                        csvContent += headers.map(header => `"${(row[header] || '').toString().replace(/"/g, '""')}"`).join(',') + '\n';
                    });
                    this.downloadFile(`${type}_export.csv`, csvContent, 'text/csv');
                }
            },

            downloadFile(filename, content, mimeType) {
                const blob = new Blob([content], { type: mimeType });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.click();
                URL.revokeObjectURL(link.href);
            },

            // --- UI Helpers ---
            showAlert(message, type = 'info') { // type: info, success, warning, danger
                const alertBox = document.createElement('div');
                alertBox.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 1rem 1.5rem;
                    border-radius: var(--border-radius);
                    color: white;
                    background-color: ${type === 'success' ? 'var(--success-color)' : type === 'danger' ? 'var(--danger-color)' : type === 'warning' ? 'var(--warning-color)' : 'var(--primary-color)'};
                    box-shadow: var(--shadow);
                    z-index: 9999;
                    opacity: 0;
                    transition: opacity 0.5s;
                `;
                if(type === 'warning') alertBox.style.color = 'var(--text-color)';
                alertBox.textContent = message;
                document.body.appendChild(alertBox);
                
                setTimeout(() => alertBox.style.opacity = 1, 10);
                setTimeout(() => {
                    alertBox.style.opacity = 0;
                    setTimeout(() => alertBox.remove(), 500);
                }, 4000);
            },

            closeModal() {
                const modal = document.getElementById('modal-container');
                modal.innerHTML = '';
            },

            handleModalClick(e) {
                if (e.target.matches('.modal-overlay') || e.target.matches('.close-modal')) {
                    this.closeModal();
                }
                
                const actionTarget = e.target.closest('[data-action]');
                if (!actionTarget) return;

                const { action, staffId, itemId } = actionTarget.dataset;
                if (!action || !staffId || !itemId) return;

                const profile = this.state.profiles[staffId];
                if (!profile) return;

                const confirmAndAct = (listName, itemName) => {
                    if (confirm(`Are you sure you want to remove this ${itemName}?`)) {
                        profile[listName] = profile[listName].filter(item => item.id !== itemId);
                        this.saveState();
                        this.renderProfileModal(staffId); // Re-render modal content
                    }
                };

                switch(action) {
                    case 'remove-reward': confirmAndAct('rewards', 'reward'); break;
                    case 'remove-promotion': confirmAndAct('promotions', 'promotion'); break;
                    case 'remove-achievement': confirmAndAct('achievements', 'achievement'); break;
                }
            },

            handleModalSubmit(e) {
                e.preventDefault();
                const form = e.target;
                const { formType, staffId } = form.dataset;
                if (!formType || !staffId) return;
                
                const profile = this.state.profiles[staffId];
                if (!profile) return;

                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                data.id = this.generateId();

                switch(formType) {
                    case 'profile-info':
                        for (let [key, value] of formData.entries()) {
                            profile.info[key] = value;
                        }
                        this.showAlert('Profile info saved.', 'success');
                        break;
                    case 'reward':
                        profile.rewards = profile.rewards || [];
                        profile.rewards.push(data);
                        profile.performance.points = (profile.performance.points || 0) + parseInt(data.points, 10);
                        this.showAlert('Reward added.', 'success');
                        break;
                     case 'promotion':
                        profile.promotions = profile.promotions || [];
                        profile.promotions.push(data);
                        this.showAlert('Promotion added.', 'success');
                        break;
                    case 'achievement':
                        profile.achievements = profile.achievements || [];
                        profile.achievements.push(data);
                        this.showAlert('Achievement added.', 'success');
                        break;
                }
                
                form.reset();
                this.saveState();
                this.renderProfileModal(staffId);
            },

            renderProfileModal(staffId) {
                const container = document.getElementById('modal-container');
                const staff = this.state.staff.find(s => s.id === staffId);
                if (!this.state.profiles[staffId]) {
                    this.state.profiles[staffId] = { info: {}, performance: { points: 0 }, rewards: [], promotions: [], achievements: [], documents: [] };
                }
                const profile = this.state.profiles[staffId];
                const info = profile.info || {};
                const performance = profile.performance || { points: 0 };
                const rewards = profile.rewards || [];
                const promotions = profile.promotions || [];
                const achievements = profile.achievements || [];

                const totalWorked = this.state.sessions
                    .filter(s => s.staffId === staffId)
                    .reduce((total, s) => total + this.calculateWorkedMinutes(staffId, s.date), 0);

                const renderTable = (title, items, headers, renderRow) => {
                    let table = `<div class="table-container"><table><thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>`;
                    if (items.length > 0) {
                        table += items.map(renderRow).join('');
                    } else {
                        table += `<tr><td colspan="${headers.length}">No ${title.toLowerCase()} recorded.</td></tr>`;
                    }
                    table += `</tbody></table></div>`;
                    return table;
                };

                const modalHTML = `
                    <div class="modal-overlay">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2>Profile: ${staff.name} (${staff.id})</h2>
                                <button class="close-modal">&times;</button>
                            </div>
                            
                            <div class="kpi-grid">
                                <div class="kpi-card"><h3>Joined Date</h3><p>${info.joinDate || 'N/A'}</p></div>
                                <div class="kpi-card"><h3>Total Worked</h3><p>${this.minToHHMM(totalWorked)}</p></div>
                                <div class="kpi-card"><h3>Points</h3><p>${performance.points}</p></div>
                                <div class="kpi-card"><h3>Current Package</h3><p>${info.package || 'N/A'}</p></div>
                            </div>

                            <div class="profile-section">
                                <h3>Personal Information</h3>
                                <form data-form-type="profile-info" data-staff-id="${staffId}">
                                    <div class="form-grid">
                                        <div class="form-group"><label>Full Name</label><input type="text" name="fullName" value="${info.fullName || ''}"></div>
                                        <div class="form-group"><label>ID No.</label><input type="text" name="idNo" value="${info.idNo || ''}"></div>
                                        <div class="form-group"><label>Date of Birth</label><input type="date" name="dob" value="${info.dob || ''}"></div>
                                        <div class="form-group"><label>Join Date</label><input type="date" name="joinDate" value="${info.joinDate || ''}"></div>
                                        <div class="form-group"><label>Phone</label><input type="tel" name="phone" value="${info.phone || ''}"></div>
                                        <div class="form-group"><label>Email</label><input type="email" name="email" value="${info.email || ''}"></div>
                                        <div class="form-group"><label>Current Package</label><input type="text" name="package" value="${info.package || ''}"></div>
                                    </div>
                                    <div class="form-group"><label>Address</label><textarea name="address">${info.address || ''}</textarea></div>
                                    <div class="form-group"><label>Qualifications</label><textarea name="qualifications">${info.qualifications || ''}</textarea></div>
                                    <button type="submit" class="btn btn-primary">Save Info</button>
                                </form>
                            </div>

                            <div class="profile-section">
                                <h3>Rewards</h3>
                                ${renderTable('Rewards', rewards, ['Date', 'Points', 'Reason', 'Action'], item => `
                                    <tr>
                                        <td>${item.date}</td>
                                        <td>${item.points}</td>
                                        <td>${item.reason}</td>
                                        <td><button class="btn btn-danger btn-sm" data-action="remove-reward" data-staff-id="${staffId}" data-item-id="${item.id}">X</button></td>
                                    </tr>
                                `)}
                                <form class="form-grid mt-1" data-form-type="reward" data-staff-id="${staffId}">
                                    <input type="date" name="date" required>
                                    <input type="number" name="points" placeholder="Points" required>
                                    <input type="text" name="reason" placeholder="Reason" required>
                                    <button type="submit" class="btn btn-success">Add Reward</button>
                                </form>
                            </div>
                            
                            <div class="profile-section">
                                <h3>Promotions</h3>
                                ${renderTable('Promotions', promotions, ['Date', 'Title', 'Remarks', 'Action'], item => `
                                    <tr>
                                        <td>${item.date}</td>
                                        <td>${item.title}</td>
                                        <td>${item.remarks}</td>
                                        <td><button class="btn btn-danger btn-sm" data-action="remove-promotion" data-staff-id="${staffId}" data-item-id="${item.id}">X</button></td>
                                    </tr>
                                `)}
                                <form class="form-grid mt-1" data-form-type="promotion" data-staff-id="${staffId}">
                                    <input type="date" name="date" required>
                                    <input type="text" name="title" placeholder="New Title" required>
                                    <input type="text" name="remarks" placeholder="Remarks">
                                    <button type="submit" class="btn btn-success">Add Promotion</button>
                                </form>
                            </div>

                            <div class="profile-section">
                                <h3>Achievements</h3>
                                ${renderTable('Achievements', achievements, ['Date', 'Title', 'Description', 'Action'], item => `
                                    <tr>
                                        <td>${item.date}</td>
                                        <td>${item.title}</td>
                                        <td>${item.description}</td>
                                        <td><button class="btn btn-danger btn-sm" data-action="remove-achievement" data-staff-id="${staffId}" data-item-id="${item.id}">X</button></td>
                                    </tr>
                                `)}
                                <form class="form-grid mt-1" data-form-type="achievement" data-staff-id="${staffId}">
                                    <input type="date" name="date" required>
                                    <input type="text" name="title" placeholder="Title" required>
                                    <input type="text" name="description" placeholder="Description">
                                    <button type="submit" class="btn btn-success">Add Achievement</button>
                                </form>
                            </div>
                            
                            <div class="profile-section">
                                <h3>Documents</h3>
                                <p>View and manage documents from the "My Profile" tab.</p>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML = modalHTML;
            }
        };

        // --- Start the App ---
        App.init();
    });
    </script>
</body>
</html>
