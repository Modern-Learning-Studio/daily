<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLS DAILY</title>
    <style>
        /* CSS Variables for theming and consistency */
        :root {
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --primary-color: #0052cc;
            --primary-color-light: #deebff;
            --primary-color-dark: #003e99;
            --secondary-color: #f4f5f7;
            --text-color: #172b4d;
            --text-color-light: #5e6c84;
            --border-color: #dfe1e6;
            --background-color: #fafbfc;
            --card-background: #ffffff;
            --success-color: #00875a;
            --success-bg: #e3fcef;
            --warning-color: #ffab00;
            --warning-bg: #fff0b3;
            --danger-color: #de350b;
            --danger-bg: #ffebe6;
            --border-radius: 12px;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --transition-speed: 0.2s;
        }

        /* Basic Reset and Global Styles */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        #app {
            display: flex;
            flex-direction: column;
            height: 100%;
            opacity: 1;
            transition: opacity var(--transition-speed) ease-in-out;
        }
        
        #app.loading::before {
            content: 'Loading...';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5rem;
            color: var(--text-color-light);
            z-index: 100;
        }

        #app.loading > * {
            opacity: 0;
        }

        /* Utility Classes */
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        .card {
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .grid {
            display: grid;
            gap: 1.5rem;
        }
        @media (min-width: 768px) {
            .grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
        }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-1 { gap: 0.25rem; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .mt-4 { margin-top: 1rem; }
        .mb-4 { margin-bottom: 1rem; }
        .text-sm { font-size: 0.875rem; }
        .text-light { color: var(--text-color-light); }
        .font-bold { font-weight: 600; }
        .w-full { width: 100%; }
        .hidden { display: none !important; }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            border: 1px solid transparent;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            text-decoration: none;
            white-space: nowrap;
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .btn:focus-visible {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .btn-primary:hover:not(:disabled) { background-color: var(--primary-color-dark); }
        .btn-secondary {
            background-color: var(--secondary-color);
            color: var(--text-color);
            border-color: var(--border-color);
        }
        .btn-secondary:hover:not(:disabled) { background-color: #e9ebf0; }
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        .btn-danger:hover:not(:disabled) { background-color: #bf2600; }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.8rem; }

        /* Form Elements */
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-color);
        }
        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--background-color);
            transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
        }
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px var(--primary-color-light);
        }
        .form-error {
            color: var(--danger-color);
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: none;
        }

        /* Login Screen */
        #login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-grow: 1;
            padding: 1rem;
        }
        #login-card {
            width: 100%;
            max-width: 400px;
        }
        #login-card h1 {
            text-align: center;
            margin-bottom: 1.5rem;
            color: var(--primary-color);
        }
        #pin-tips {
            font-size: 0.8rem;
            text-align: center;
            margin-top: 1rem;
            color: var(--text-color-light);
        }

        /* Main App Layout */
        #main-app {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* Header */
        .app-header {
            position: sticky;
            top: 0;
            background-color: var(--card-background);
            box-shadow: var(--shadow-sm);
            padding: 0.75rem 1rem;
            z-index: 10;
            border-bottom: 1px solid var(--border-color);
        }
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .brand {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        .user-badge {
            background-color: var(--primary-color-light);
            color: var(--primary-color-dark);
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
            text-align: center;
        }
        .header-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* Tab Navigation */
        .tab-nav {
            background-color: var(--card-background);
            padding: 0.5rem 1rem;
            overflow-x: auto;
            white-space: nowrap;
            border-bottom: 1px solid var(--border-color);
        }
        .tab-nav::-webkit-scrollbar {
            height: 4px;
        }
        .tab-nav::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }
        .tab-btn {
            padding: 0.6rem 1rem;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text-color-light);
            border-radius: 8px;
            transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
        }
        .tab-btn.active {
            background-color: var(--primary-color-light);
            color: var(--primary-color-dark);
            font-weight: 600;
        }
        .tab-btn:hover:not(.active) {
            background-color: var(--secondary-color);
        }

        /* Main Content Area */
        .main-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        .view-content {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Tables */
        .table-wrapper {
            overflow-x: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        thead {
            background-color: var(--secondary-color);
            position: sticky;
            top: 0;
            z-index: 1;
        }
        th {
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            color: var(--text-color-light);
        }
        tbody tr:last-child td {
            border-bottom: none;
        }
        tbody tr:hover {
            background-color: #f9fafb;
        }

        /* Status Pills */
        .status-pill {
            display: inline-block;
            padding: 0.25rem 0.6rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: capitalize;
        }
        .status-pill.approved, .status-pill.active { background-color: var(--success-bg); color: var(--success-color); }
        .status-pill.pending { background-color: var(--warning-bg); color: var(--warning-color); }
        .status-pill.rejected, .status-pill.inactive { background-color: var(--danger-bg); color: var(--danger-color); }

        /* Profile Drawer */
        .drawer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 20;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-speed) ease, visibility var(--transition-speed) ease;
        }
        .drawer-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        .drawer {
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            max-width: 400px;
            height: 100%;
            background-color: var(--card-background);
            box-shadow: var(--shadow-lg);
            transform: translateX(100%);
            transition: transform var(--transition-speed) ease-in-out;
            display: flex;
            flex-direction: column;
        }
        .drawer.open {
            transform: translateX(0);
        }
        .drawer-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .drawer-header h3 { font-size: 1.25rem; }
        .drawer-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex-grow: 1;
        }
        .drawer-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-color-light);
        }
        .profile-kpi {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .kpi-card {
            background-color: var(--secondary-color);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }
        .kpi-card .value { font-size: 1.5rem; font-weight: 700; color: var(--primary-color); }
        .kpi-card .label { font-size: 0.8rem; color: var(--text-color-light); }

        /* Custom Toast/Message Box */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--text-color);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            transform: translate(-50%, 20px);
        }
        .toast.show {
            opacity: 1;
            transform: translate(-50%, 0);
        }
        .toast.success { background-color: var(--success-color); }
        .toast.error { background-color: var(--danger-color); }

    </style>
</head>
<body>

    <div id="app" class="loading">
        <!-- Login Screen -->
        <div id="login-screen" class="hidden">
            <div id="login-card" class="card">
                <h1>MLS DAILY</h1>
                <form id="login-form">
                    <div class="form-group">
                        <label for="centre-select">Centre</label>
                        <select id="centre-select" class="form-control" required></select>
                    </div>
                    <div class="form-group">
                        <label for="pin-input">PIN</label>
                        <input type="password" id="pin-input" class="form-control" inputmode="numeric" pattern="[0-9]*" required autocomplete="off">
                        <div id="login-error" class="form-error">Invalid PIN or Inactive Account.</div>
                    </div>
                    <button type="submit" class="btn btn-primary w-full">Login</button>
                </form>
                <p id="pin-tips" class="text-light">Sample PINs: 0000 (Admin), 1001, 1002</p>
            </div>
        </div>

        <!-- Main Application -->
        <div id="main-app" class="hidden">
            <header class="app-header">
                <div class="header-content">
                    <span class="brand">MLS DAILY</span>
                    <div id="user-badge" class="user-badge"></div>
                    <div id="header-actions" class="header-actions">
                        <!-- Buttons will be injected here -->
                    </div>
                </div>
            </header>
            <nav id="tab-nav" class="tab-nav">
                <!-- Tabs will be injected here -->
            </nav>
            <main id="main-content" class="main-content">
                <!-- View content will be injected here -->
            </main>
        </div>

        <!-- Profile Drawer -->
        <div id="profile-drawer-overlay" class="drawer-overlay">
            <aside id="profile-drawer" class="drawer">
                <header class="drawer-header">
                    <h3 id="drawer-title">Staff Profile</h3>
                    <button id="drawer-close" class="drawer-close" aria-label="Close profile">&times;</button>
                </header>
                <div id="drawer-body" class="drawer-body">
                    <!-- Drawer content will be injected here -->
                </div>
            </aside>
        </div>
        
        <!-- Toast Notification -->
        <div id="toast-container"></div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, writeBatch, getDocs, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- CONSTANTS & CONFIG ---
        const STATE_KEY = 'MLS_DAILY_STATE_V4_SESSION'; // Changed to session storage for non-persistent local data
        const ADMIN_PIN = '0000';

        // --- DOM ELEMENTS ---
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);
        const app = $('#app');
        const loginScreen = $('#login-screen');
        const mainApp = $('#main-app');
        const loginForm = $('#login-form');
        const centreSelect = $('#centre-select');
        const pinInput = $('#pin-input');
        const loginError = $('#login-error');
        const userBadge = $('#user-badge');
        const headerActions = $('#header-actions');
        const tabNav = $('#tab-nav');
        const mainContent = $('#main-content');
        const profileDrawerOverlay = $('#profile-drawer-overlay');
        const profileDrawer = $('#profile-drawer');
        const drawerClose = $('#drawer-close');
        const drawerTitle = $('#drawer-title');
        const drawerBody = $('#drawer-body');

        // --- FIREBASE & GLOBAL STATE ---
        let db, auth, appId;
        let unsubscribeListeners = []; // To detach listeners on logout
        
        // This is now a local cache, the source of truth is Firestore
        let state = {
            settings: {},
            staff: [],
            profiles: {},
            sessions: [],
            leaves: [],
            holidays: [],
            notices: [],
            shifts: [],
            inbox: [],
            salaryRequests: [],
            currentUser: null,
            currentCentre: null,
        };

        // --- STATE MANAGEMENT (Now with FIREBASE) ---
        const stateManager = {
            getSessionState: () => JSON.parse(sessionStorage.getItem(STATE_KEY)),
            saveSessionState: () => sessionStorage.setItem(STATE_KEY, JSON.stringify({
                currentUser: state.currentUser,
                currentCentre: state.currentCentre
            })),
            clearSessionState: () => sessionStorage.removeItem(STATE_KEY),
            
            async initFirebase() {
                // These variables are expected to be provided by the environment
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
                const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (!firebaseConfig) {
                    app.innerHTML = '<h1>Firebase configuration is missing.</h1>';
                    console.error("Firebase config is missing.");
                    return;
                }

                const firebaseApp = initializeApp(firebaseConfig);
                db = getFirestore(firebaseApp);
                auth = getAuth(firebaseApp);

                try {
                    if (authToken) {
                        await signInWithCustomToken(auth, authToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                    console.log("Firebase auth successful.");
                    await this.loadInitialData();
                } catch (error) {
                    console.error("Firebase initialization failed:", error);
                    app.innerHTML = '<h1>Could not connect to the database.</h1>';
                }
            },

            async loadInitialData() {
                const basePath = `artifacts/${appId}/public/data`;
                // Check if data needs to be seeded
                const settingsDoc = await getDoc(doc(db, `${basePath}/config/settings`));
                if (!settingsDoc.exists()) {
                    showToast('First time setup. Seeding initial data to database...', 'info', 5000);
                    await this.seedDataToFirestore();
                }

                // Attach real-time listeners
                const collectionsToSync = [
                    'staff', 'sessions', 'leaves', 'holidays', 'notices', 'shifts', 'inbox', 'salaryRequests'
                ];

                // Detach previous listeners if any
                unsubscribeListeners.forEach(unsub => unsub());
                unsubscribeListeners = [];

                const settingsUnsub = onSnapshot(doc(db, `${basePath}/config/settings`), (doc) => {
                    state.settings = doc.data() || {};
                    // Re-render if a view depends on settings
                    if(state.currentUser) render.view($('.tab-btn.active')?.dataset.tab || 'Today');
                });
                unsubscribeListeners.push(settingsUnsub);

                collectionsToSync.forEach(coll => {
                    const q = query(collection(db, `${basePath}/${coll}`));
                    const unsub = onSnapshot(q, (snapshot) => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        state[coll] = data;
                        // For profiles, we'll map it to an object for easy lookup
                        if (coll === 'staff') {
                            state.profiles = data.reduce((acc, staff) => {
                                acc[staff.id] = staff.profile || {};
                                return acc;
                            }, {});
                        }
                        // Re-render the current view to show updated data
                        if(state.currentUser) render.view($('.tab-btn.active')?.dataset.tab || 'Today');
                    });
                    unsubscribeListeners.push(unsub);
                });

                // Once initial data structure is ready, check for session
                const session = this.getSessionState();
                if (session && session.currentUser) {
                    state.currentUser = session.currentUser;
                    state.currentCentre = session.currentCentre;
                    render.app();
                } else {
                    render.login();
                }
                app.classList.remove('loading');
            },

            async seedDataToFirestore() {
                const today = utils.today();
                const seed = {
                    settings: {
                        org: "MLS Innovations",
                        centres: ["MLS - Colombo 4", "Finnish Preschool - Park Road", "Forest School - Piliyandala", "SenSoMo - One Galle Face", "Forest School - Cape Weligama"],
                        breakMins: 30,
                        targetMins: 480,
                        halfDayMins: 240,
                        webhook: "",
                    },
                    staff: [
                        { id: "1001", name: "John Doe", role: "Developer", pin: "1001", defaultWorksite: "MLS - Colombo 4", joinDate: "2023-01-10", active: true, profile: { phone: "123-456-7890", email: "john.doe@example.com", performance: { points: 120 }, documents: [] } },
                        { id: "1002", name: "Jane Smith", role: "Designer", pin: "1002", defaultWorksite: "Finnish Preschool - Park Road", joinDate: "2023-03-15", active: true, profile: { phone: "098-765-4321", email: "jane.smith@example.com", performance: { points: 65 }, documents: [] } },
                    ],
                    sessions: [
                        { staffId: "1001", date: today, centre: "MLS - Colombo 4", clockIn: `${today}T09:00:00`, clockOut: null, breaks: [] },
                        { staffId: "1002", date: today, centre: "Finnish Preschool - Park Road", clockIn: `${today}T09:30:00`, clockOut: null, breaks: [] },
                    ],
                    leaves: [
                        { staffId: "1002", date: today, type: "Short", minutes: 60, reason: "Appointment", status: "Pending", appliedAt: new Date().toISOString() }
                    ],
                    holidays: [
                        { date: "2025-08-20", title: "Poya Day" }
                    ],
                    notices: [
                        { title: "Welcome!", body: "Welcome to the new MLS DAILY portal.", centre: "All", createdAt: new Date().toISOString() }
                    ],
                };

                const batch = writeBatch(db);
                const basePath = `artifacts/${appId}/public/data`;

                // Set settings
                batch.set(doc(db, `${basePath}/config/settings`), seed.settings);

                // Add staff (using their ID as document ID)
                seed.staff.forEach(s => {
                    const staffDocRef = doc(db, `${basePath}/staff`, s.id);
                    batch.set(staffDocRef, s);
                });
                
                // Add other collections
                ['sessions', 'leaves', 'holidays', 'notices'].forEach(coll => {
                    seed[coll].forEach(item => {
                        const newDocRef = doc(collection(db, `${basePath}/${coll}`));
                        batch.set(newDocRef, item);
                    });
                });

                await batch.commit();
            },
        };

        // --- UTILS ---
        const utils = {
            today: () => new Date().toLocaleDateString('en-CA'), // YYYY-MM-DD
            formatDate: (isoString) => new Date(isoString).toLocaleDateString('en-CA'),
            formatDateTime: (isoString) => new Date(isoString).toLocaleString([], { dateStyle: 'short', timeStyle: 'short' }),
            formatTime: (isoString) => isoString ? new Date(isoString).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '---',
            hhmmToMin: (hhmm) => {
                if (!hhmm || !hhmm.includes(':')) return 0;
                const [h, m] = hhmm.split(':').map(Number);
                return h * 60 + m;
            },
            minToHHMM: (mins) => {
                if (isNaN(mins) || mins < 0) return '00:00';
                const h = Math.floor(mins / 60).toString().padStart(2, '0');
                const m = Math.round(mins % 60).toString().padStart(2, '0');
                return `${h}:${m}`;
            },
            getWorkedMinutes(staffId, date) {
                const staffSessions = state.sessions.filter(s => s.staffId === staffId && s.date === date);
                let totalMins = staffSessions.reduce((acc, session) => {
                    if (session.clockIn && session.clockOut) {
                        const start = new Date(session.clockIn);
                        const end = new Date(session.clockOut);
                        return acc + (end - start) / (1000 * 60);
                    }
                    return acc;
                }, 0);

                // Subtract breaks
                totalMins -= state.settings.breakMins;

                // Handle leaves
                const approvedLeaves = state.leaves.filter(l => l.staffId === staffId && l.date === date && l.status === 'Approved');
                if (approvedLeaves.some(l => l.type === 'Full')) return 0;
                
                const shortLeaveMins = approvedLeaves
                    .filter(l => l.type === 'Short')
                    .reduce((acc, l) => acc + (l.minutes || 0), 0);
                totalMins -= shortLeaveMins;

                if (approvedLeaves.some(l => l.type === 'Half')) {
                    totalMins = Math.min(totalMins, state.settings.halfDayMins);
                }

                return Math.max(0, Math.round(totalMins));
            },
            escapeHTML(str) {
                if (typeof str !== 'string') return '';
                return str.replace(/[&<>"']/g, (match) => ({
                    '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
                }[match]));
            }
        };

        // --- UI RENDERING ---
        const render = {
            login() {
                if (state.settings.centres && state.settings.centres.length > 0) {
                    centreSelect.innerHTML = state.settings.centres
                        .map(c => `<option value="${utils.escapeHTML(c)}">${utils.escapeHTML(c)}</option>`)
                        .join('');
                } else {
                     centreSelect.innerHTML = '<option>Loading centres...</option>';
                }
                loginScreen.classList.remove('hidden');
                mainApp.classList.add('hidden');
            },
            app() {
                let user;
                if (state.currentUser.role === 'Admin') {
                    user = { name: 'Admin' };
                } else {
                    user = state.staff.find(s => s.id === state.currentUser.id);
                }

                if (!user) {
                    showToast('Could not find your user profile. Logging out.', 'error');
                    events.auth.logout();
                    return;
                }

                userBadge.innerHTML = `
                    <span class="font-bold">${utils.escapeHTML(user.name)}</span> (${utils.escapeHTML(state.currentUser.role)})
                    <br>
                    <span class="text-sm">${utils.escapeHTML(state.currentCentre)}</span>
                `;
                this.headerActions();
                this.tabs();
                loginScreen.classList.add('hidden');
                mainApp.classList.remove('hidden');
                const activeTab = state.currentUser.role === 'Admin' ? 'Today' : 'My Dashboard';
                this.view(activeTab);
            },
            headerActions() {
                headerActions.innerHTML = `
                    <button class="btn btn-secondary btn-sm" data-action="test-webhook">Test Webhook</button>
                    <button class="btn btn-secondary btn-sm" data-action="load-webhook">Load from Webhook</button>
                    <button class="btn btn-secondary btn-sm" data-action="sync-webhook">Sync â†’ Webhook</button>
                    <button class="btn btn-danger btn-sm" data-action="logout">Logout</button>
                `;
            },
            tabs() {
                const adminTabs = ['Today', 'Attendance', 'Shift Planner', 'Staff', 'Leaves', 'Holidays', 'Inbox', 'Rewards', 'Settings', 'Export', 'Notice Board', 'Payroll'];
                const staffTabs = ['My Dashboard', 'Clock', 'My Leaves', 'My Requests', 'Company Holidays', 'Notice Board', 'My Profile'];
                const tabs = state.currentUser.role === 'Admin' ? adminTabs : staffTabs;
                
                tabNav.innerHTML = tabs.map((tab, index) => `
                    <button class="tab-btn ${index === 0 ? 'active' : ''}" data-tab="${tab}">${tab}</button>
                `).join('');
            },
            view(tabName, options = {}) {
                if (!tabName) return;
                $$('.tab-btn').forEach(btn => btn.classList.remove('active'));
                $(`.tab-btn[data-tab="${tabName}"]`)?.classList.add('active');
                
                mainContent.innerHTML = `<div class="view-content">${this.getViewHtml(tabName, options)}</div>`;
                this.attachViewListeners(tabName);
            },
            getViewHtml(tabName, options) {
                switch (tabName) {
                    // --- ADMIN VIEWS ---
                    case 'Today': return this.views.admin.today();
                    case 'Attendance': return this.views.admin.attendance(options);
                    case 'Shift Planner': return this.views.admin.shiftPlanner();
                    case 'Staff': return this.views.admin.staff();
                    case 'Leaves': return this.views.admin.leaves();
                    case 'Holidays': return this.views.admin.holidays();
                    case 'Inbox': return this.views.admin.inbox();
                    case 'Rewards': return this.views.admin.rewards();
                    case 'Settings': return this.views.admin.settings();
                    case 'Export': return this.views.admin.export();
                    case 'Notice Board': return this.views.admin.noticeBoard();
                    case 'Payroll': return this.views.admin.payroll();
                    // --- STAFF VIEWS ---
                    case 'My Dashboard': return this.views.staff.dashboard();
                    case 'Clock': return this.views.staff.clock();
                    case 'My Leaves': return this.views.staff.myLeaves();
                    case 'My Requests': return this.views.staff.myRequests();
                    case 'Company Holidays': return this.views.staff.companyHolidays();
                    case 'Notice Board': return this.views.staff.noticeBoard();
                    case 'My Profile': return this.views.staff.myProfile();
                    default: return `<h2>View not found: ${tabName}</h2>`;
                }
            },
            attachViewListeners(tabName) {
                const viewContent = $('.view-content');
                if (!viewContent) return;

                const handlers = {
                    'Today': () => {
                        $('#today-centre-filter')?.addEventListener('change', () => this.view('Today'));
                    },
                    'Attendance': () => {
                        $('#run-attendance-report')?.addEventListener('click', () => {
                            const filters = {
                                start: $('#attendance-start-date').value,
                                end: $('#attendance-end-date').value,
                                staffId: $('#attendance-staff-filter').value,
                                centre: $('#attendance-centre-filter').value,
                            };
                            this.view('Attendance', { filters });
                        });
                    },
                    'Shift Planner': () => {
                        $('#add-shift-form')?.addEventListener('submit', events.shifts.add);
                        viewContent.addEventListener('click', e => {
                            if (e.target.matches('[data-action="delete-shift"]')) {
                                events.shifts.delete(e.target.dataset.id);
                            }
                        });
                    },
                    'Staff': () => {
                        $('#add-staff-form')?.addEventListener('submit', events.staff.add);
                        viewContent.addEventListener('click', e => {
                            const action = e.target.dataset.action;
                            const id = e.target.dataset.id;
                            if (action === 'toggle-status') events.staff.toggleStatus(id);
                            if (action === 'remove-staff') events.staff.remove(id);
                            if (action === 'view-profile') events.staff.viewProfile(id);
                        });
                    },
                    'Leaves': () => {
                        $('#admin-submit-leave-form')?.addEventListener('submit', events.leaves.adminSubmit);
                        $('#admin-leave-type')?.addEventListener('change', e => {
                           $('#admin-short-leave-minutes-group').classList.toggle('hidden', e.target.value !== 'Short');
                        });
                        viewContent.addEventListener('click', e => {
                            if (e.target.matches('[data-action^="update-leave-status"]')) {
                                const [_, __, ___, status, id] = e.target.dataset.action.split('-');
                                events.leaves.updateStatus(id, status);
                            }
                        });
                    },
                    'Holidays': () => {
                        $('#add-holiday-form')?.addEventListener('submit', events.holidays.add);
                        viewContent.addEventListener('click', e => {
                            if (e.target.matches('[data-action="delete-holiday"]')) {
                                events.holidays.delete(e.target.dataset.id);
                            }
                        });
                    },
                    'Inbox': () => {
                        viewContent.addEventListener('click', e => {
                            const button = e.target.closest('button[data-action]');
                            if (!button) return;
                            const action = button.dataset.action;
                            const id = button.dataset.id;
                            if (action && id) {
                                const [type, status, reqType] = action.split('-');
                                if (type === 'update') {
                                    events.inbox.updateStatus(id, status, reqType);
                                }
                            }
                        });
                    },
                    'Rewards': () => {
                        $('#award-points-form')?.addEventListener('submit', events.rewards.award);
                    },
                    'Settings': () => {
                        $('#settings-form')?.addEventListener('submit', events.settings.save);
                        $('#add-centre-btn')?.addEventListener('click', events.settings.addCentre);
                        viewContent.addEventListener('click', e => {
                            if (e.target.matches('[data-action="remove-centre"]')) {
                                events.settings.removeCentre(e.target.dataset.centre);
                            }
                        });
                    },
                    'Export': () => {
                        viewContent.addEventListener('click', e => {
                            const action = e.target.dataset.action;
                            if (action === 'export-staff') events.export.staff();
                            if (action === 'export-sessions') events.export.sessions();
                            if (action === 'export-leaves') events.export.leaves();
                            if (action === 'export-shifts') events.export.shifts();
                            if (action === 'export-json') events.export.json();
                        });
                    },
                    'Notice Board': () => {
                        $('#post-notice-form')?.addEventListener('submit', events.notices.add);
                    },
                    'Clock': () => {
                        viewContent.addEventListener('click', e => {
                            const action = e.target.dataset.action;
                            if (action === 'clock-in') events.clock.clockIn();
                            if (action === 'clock-out') events.clock.clockOut();
                            if (action === 'start-break') events.clock.startBreak();
                            if (action === 'end-break') events.clock.endBreak();
                        });
                    },
                    'My Leaves': () => {
                        $('#request-leave-form')?.addEventListener('submit', events.leaves.staffRequest);
                        $('#leave-type-select')?.addEventListener('change', e => {
                           $('#short-leave-minutes-group').classList.toggle('hidden', e.target.value !== 'Short');
                        });
                    },
                    'My Requests': () => {
                        $('#new-request-form')?.addEventListener('submit', events.requests.submitGeneral);
                        $('#salary-request-form')?.addEventListener('submit', events.requests.submitSalary);
                    },
                    'My Profile': () => {
                        $('#upload-document-form')?.addEventListener('submit', events.profile.uploadDocument);
                    },
                };
                handlers[tabName]?.();
            },
            profileDrawer(staffId) {
                const staff = state.staff.find(s => s.id === staffId);
                const profile = staff.profile || {};
                const sessions = state.sessions.filter(s => s.staffId === staffId);
                const totalMins = sessions.reduce((sum, s) => sum + utils.getWorkedMinutes(staffId, s.date), 0);

                drawerTitle.textContent = `${staff.name}'s Profile`;
                drawerBody.innerHTML = `
                    <div class="profile-kpi">
                        <div class="kpi-card">
                            <div class="value">${new Date(staff.joinDate).toLocaleDateString()}</div>
                            <div class="label">Joined Date</div>
                        </div>
                        <div class="kpi-card">
                            <div class="value">${sessions.length}</div>
                            <div class="label">Total Sessions</div>
                        </div>
                        <div class="kpi-card">
                            <div class="value">${utils.minToHHMM(totalMins)}</div>
                            <div class="label">Total Worked</div>
                        </div>
                        <div class="kpi-card">
                            <div class="value">${profile.performance?.points || 0}</div>
                            <div class="label">Points</div>
                        </div>
                    </div>
                    <h4>Information</h4>
                    <p><strong>Role:</strong> ${utils.escapeHTML(staff.role)}</p>
                    <p><strong>Default Centre:</strong> ${utils.escapeHTML(staff.defaultWorksite)}</p>
                    <p><strong>Phone:</strong> ${utils.escapeHTML(profile.phone || 'N/A')}</p>
                    <p><strong>Email:</strong> ${utils.escapeHTML(profile.email || 'N/A')}</p>
                    <hr class="my-4">
                    <h4>Documents</h4>
                    <ul id="document-list" class="list-disc pl-5 mb-4">
                        ${(profile.documents || []).map((doc, index) => `
                            <li><a href="${doc.dataUrl}" download="${doc.name}">${utils.escapeHTML(doc.name)}</a></li>
                        `).join('') || '<li>No documents uploaded.</li>'}
                    </ul>
                    <form id="upload-profile-document-form">
                         <input type="hidden" name="staffId" value="${staffId}">
                         <div class="form-group">
                            <label for="profile-doc-upload">Upload New Document</label>
                            <input type="file" id="profile-doc-upload" class="form-control" required>
                         </div>
                         <button type="submit" class="btn btn-primary btn-sm">Upload</button>
                    </form>
                `;
                $('#upload-profile-document-form')?.addEventListener('submit', events.profile.uploadDocumentFromDrawer);
                profileDrawerOverlay.classList.add('open');
                profileDrawer.classList.add('open');
            },
            views: {
                admin: {
                  today() {
                    const selectedCentre = $('#today-centre-filter')?.value || 'All';
                    const today = utils.today();
                    const sessionsToday = state.sessions.filter(s => s.date === today && (selectedCentre === 'All' || s.centre === selectedCentre));
                    const staffMap = new Map(state.staff.map(s => [s.id, s]));

                    const notices = state.notices
                        .filter(n => n.centre === 'All' || n.centre === selectedCentre || selectedCentre === 'All')
                        .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                    return `
                      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                        <div class="lg:col-span-2">
                          <div class="card">
                            <div class="flex justify-between items-center mb-4">
                              <h2 class="text-xl font-bold">Today's Attendance</h2>
                              <div class="form-group mb-0">
                                <select id="today-centre-filter" class="form-control">
                                  <option value="All">All Centres</option>
                                  ${(state.settings.centres || []).map(c => `<option value="${utils.escapeHTML(c)}" ${selectedCentre === c ? 'selected' : ''}>${utils.escapeHTML(c)}</option>`).join('')}
                                </select>
                              </div>
                            </div>
                            <div class="table-wrapper">
                              <table>
                                <thead><tr><th>Name</th><th>Centre</th><th>Clock In</th><th>Clock Out</th></tr></thead>
                                <tbody>
                                  ${sessionsToday.length ? sessionsToday.map(s => {
                                      const staff = staffMap.get(s.staffId);
                                      return `
                                        <tr>
                                          <td>${utils.escapeHTML(staff?.name || 'Unknown')}</td>
                                          <td>${utils.escapeHTML(s.centre)}</td>
                                          <td>${utils.formatTime(s.clockIn)}</td>
                                          <td>${utils.formatTime(s.clockOut)}</td>
                                        </tr>
                                      `;
                                  }).join('') : '<tr><td colspan="4" class="text-center py-4">No sessions recorded for today.</td></tr>'}
                                </tbody>
                              </table>
                            </div>
                          </div>
                        </div>
                        <div>
                          <div class="card">
                            <h2 class="text-xl font-bold mb-4">Notice Board</h2>
                            <div class="space-y-4 max-h-96 overflow-y-auto">
                              ${notices.length ? notices.map(n => `
                                <div class="p-3 bg-secondary rounded-lg">
                                  <p class="font-bold">${utils.escapeHTML(n.title)}</p>
                                  <p class="text-sm text-light">${utils.formatDateTime(n.createdAt)} - ${utils.escapeHTML(n.centre)}</p>
                                  <p class="mt-1">${utils.escapeHTML(n.body)}</p>
                                </div>
                              `).join('') : '<p>No notices to display.</p>'}
                            </div>
                          </div>
                        </div>
                      </div>
                    `;
                  },
                  attendance(options = {}) {
                      const { filters } = options;
                      const firstDayOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toLocaleDateString('en-CA');
                      const today = utils.today();

                      let results = [];
                      if (filters) {
                          const { start, end, staffId, centre } = filters;
                          const startDate = new Date(start);
                          const endDate = new Date(end);
                          
                          const uniqueEntries = new Set();

                          for (let d = startDate; d <= endDate; d.setDate(d.getDate() + 1)) {
                              const currentDate = d.toLocaleDateString('en-CA');
                              state.sessions.forEach(session => {
                                  if (session.date === currentDate) {
                                      if ((staffId === 'All' || session.staffId === staffId) && (centre === 'All' || session.centre === centre)) {
                                          const key = `${session.staffId}-${currentDate}-${session.centre}`;
                                          if (!uniqueEntries.has(key)) {
                                              const staff = state.staff.find(s => s.id === session.staffId);
                                              if (staff) {
                                                  const workedMins = utils.getWorkedMinutes(session.staffId, currentDate);
                                                  results.push({
                                                      staffName: staff.name,
                                                      date: currentDate,
                                                      centre: session.centre,
                                                      workedMins: workedMins,
                                                      workedHHMM: utils.minToHHMM(workedMins)
                                                  });
                                                  uniqueEntries.add(key);
                                              }
                                          }
                                      }
                                  }
                              });
                          }
                      }

                      return `
                          <div class="card">
                              <h2 class="text-xl font-bold mb-4">Attendance Report</h2>
                              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-4">
                                  <div class="form-group">
                                      <label for="attendance-start-date">Start Date</label>
                                      <input type="date" id="attendance-start-date" class="form-control" value="${filters?.start || firstDayOfMonth}">
                                  </div>
                                  <div class="form-group">
                                      <label for="attendance-end-date">End Date</label>
                                      <input type="date" id="attendance-end-date" class="form-control" value="${filters?.end || today}">
                                  </div>
                                  <div class="form-group">
                                      <label for="attendance-staff-filter">Staff</label>
                                      <select id="attendance-staff-filter" class="form-control">
                                          <option value="All">All Staff</option>
                                          ${state.staff.map(s => `<option value="${s.id}" ${filters?.staffId === s.id ? 'selected' : ''}>${utils.escapeHTML(s.name)}</option>`).join('')}
                                      </select>
                                  </div>
                                  <div class="form-group">
                                      <label for="attendance-centre-filter">Centre</label>
                                      <select id="attendance-centre-filter" class="form-control">
                                          <option value="All">All Centres</option>
                                          ${(state.settings.centres || []).map(c => `<option value="${utils.escapeHTML(c)}" ${filters?.centre === c ? 'selected' : ''}>${utils.escapeHTML(c)}</option>`).join('')}
                                      </select>
                                  </div>
                                  <div class="self-end">
                                      <button id="run-attendance-report" class="btn btn-primary w-full">Run</button>
                                  </div>
                              </div>
                              <div class="table-wrapper">
                                  <table>
                                      <thead><tr><th>Staff</th><th>Date</th><th>Centre</th><th>Worked (mins)</th><th>Worked (hh:mm)</th></tr></thead>
                                      <tbody>
                                          ${results.length ? results.map(r => `
                                              <tr>
                                                  <td>${utils.escapeHTML(r.staffName)}</td>
                                                  <td>${r.date}</td>
                                                  <td>${utils.escapeHTML(r.centre)}</td>
                                                  <td>${r.workedMins}</td>
                                                  <td>${r.workedHHMM}</td>
                                              </tr>
                                          `).join('') : '<tr><td colspan="5" class="text-center py-4">Run a report to see results.</td></tr>'}
                                      </tbody>
                                  </table>
                              </div>
                          </div>
                      `;
                  },
                  shiftPlanner() {
                      const sortedShifts = [...state.shifts].sort((a,b) => new Date(`${a.date}T${a.start}`) - new Date(`${b.date}T${b.start}`));
                      return `
                        <div class="grid md:grid-cols-2 gap-4">
                            <div class="card">
                                <h2 class="text-xl font-bold mb-4">Add Shift</h2>
                                <form id="add-shift-form">
                                    <div class="form-group">
                                        <label for="shift-date">Date</label>
                                        <input type="date" id="shift-date" class="form-control" required value="${utils.today()}">
                                    </div>
                                    <div class="form-group">
                                        <label for="shift-centre">Centre</label>
                                        <select id="shift-centre" class="form-control" required>
                                            ${(state.settings.centres || []).map(c => `<option value="${utils.escapeHTML(c)}">${utils.escapeHTML(c)}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="shift-staff">Staff</label>
                                        <select id="shift-staff" class="form-control" required>
                                            ${state.staff.filter(s => s.active).map(s => `<option value="${s.id}">${utils.escapeHTML(s.name)}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="form-group">
                                            <label for="shift-start">Start Time</label>
                                            <input type="time" id="shift-start" class="form-control" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="shift-end">End Time</label>
                                            <input type="time" id="shift-end" class="form-control" required>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="shift-notes">Notes</label>
                                        <textarea id="shift-notes" class="form-control"></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Add Shift</button>
                                </form>
                            </div>
                            <div class="card">
                                <h2 class="text-xl font-bold mb-4">All Shifts</h2>
                                <div class="table-wrapper">
                                    <table>
                                        <thead><tr><th>Date</th><th>Staff</th><th>Centre</th><th>Time</th><th>Actions</th></tr></thead>
                                        <tbody>
                                            ${sortedShifts.length ? sortedShifts.map(shift => `
                                                <tr>
                                                    <td>${shift.date}</td>
                                                    <td>${state.staff.find(s => s.id === shift.staffId)?.name || 'Unknown'}</td>
                                                    <td>${utils.escapeHTML(shift.centre)}</td>
                                                    <td>${shift.start} - ${shift.end}</td>
                                                    <td><button class="btn btn-danger btn-sm" data-action="delete-shift" data-id="${shift.id}">Delete</button></td>
                                                </tr>
                                            `).join('') : '<tr><td colspan="5" class="text-center py-4">No shifts planned.</td></tr>'}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                      `;
                  },
                  staff() {
                    return `
                      <div class="grid md:grid-cols-2 gap-4">
                          <div class="card">
                              <h2 class="text-xl font-bold mb-4">Add Staff</h2>
                              <form id="add-staff-form">
                                  <div class="form-group">
                                      <label for="staff-id">Staff ID</label>
                                      <input type="text" id="staff-id" class="form-control" required>
                                  </div>
                                  <div class="form-group">
                                      <label for="staff-name">Name</label>
                                      <input type="text" id="staff-name" class="form-control" required>
                                  </div>
                                  <div class="form-group">
                                      <label for="staff-role">Role</label>
                                      <input type="text" id="staff-role" class="form-control" required>
                                  </div>
                                  <div class="form-group">
                                      <label for="staff-pin">PIN (numeric)</label>
                                      <input type="password" id="staff-pin" class="form-control" inputmode="numeric" required>
                                  </div>
                                  <div class="form-group">
                                      <label for="staff-centre">Default Centre</label>
                                      <select id="staff-centre" class="form-control" required>
                                          ${(state.settings.centres || []).map(c => `<option value="${utils.escapeHTML(c)}">${utils.escapeHTML(c)}</option>`).join('')}
                                      </select>
                                  </div>
                                  <button type="submit" class="btn btn-primary">Add Staff</button>
                              </form>
                          </div>
                          <div class="card">
                              <h2 class="text-xl font-bold mb-4">Manage Staff</h2>
                              <div class="table-wrapper">
                                  <table>
                                      <thead><tr><th>ID</th><th>Name</th><th>Role</th><th>Centre</th><th>Status</th><th>Actions</th></tr></thead>
                                      <tbody>
                                          ${state.staff.map(s => `
                                              <tr>
                                                  <td>${s.id}</td>
                                                  <td>${utils.escapeHTML(s.name)}</td>
                                                  <td>${utils.escapeHTML(s.role)}</td>
                                                  <td>${utils.escapeHTML(s.defaultWorksite)}</td>
                                                  <td><span class="status-pill ${s.active ? 'active' : 'inactive'}">${s.active ? 'Active' : 'Inactive'}</span></td>
                                                  <td class="flex flex-wrap gap-1">
                                                      <button class="btn btn-secondary btn-sm" data-action="toggle-status" data-id="${s.id}">${s.active ? 'Deactivate' : 'Activate'}</button>
                                                      <button class="btn btn-secondary btn-sm" data-action="view-profile" data-id="${s.id}">Profile</button>
                                                      <button class="btn btn-danger btn-sm" data-action="remove-staff" data-id="${s.id}">Remove</button>
                                                  </td>
                                              </tr>
                                          `).join('')}
                                      </tbody>
                                  </table>
                              </div>
                          </div>
                      </div>
                    `;
                  },
                   leaves() {
                    const allLeaves = [...state.leaves].sort((a,b) => new Date(b.appliedAt) - new Date(a.appliedAt));
                    return `
                        <div class="grid md:grid-cols-2 gap-4">
                            <div class="card">
                                <h2 class="text-xl font-bold mb-4">Submit Leave (Admin)</h2>
                                <form id="admin-submit-leave-form">
                                    <div class="form-group">
                                        <label for="admin-leave-staff">Staff</label>
                                        <select id="admin-leave-staff" class="form-control" required>
                                            ${state.staff.filter(s => s.active).map(s => `<option value="${s.id}">${utils.escapeHTML(s.name)}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="admin-leave-date">Date</label>
                                        <input type="date" id="admin-leave-date" class="form-control" required value="${utils.today()}">
                                    </div>
                                    <div class="form-group">
                                        <label for="admin-leave-type">Type</label>
                                        <select id="admin-leave-type" class="form-control" required>
                                            <option>Full</option><option>Half</option><option>Short</option>
                                        </select>
                                    </div>
                                    <div class="form-group hidden" id="admin-short-leave-minutes-group">
                                        <label for="admin-leave-minutes">Minutes (for Short Leave)</label>
                                        <input type="number" id="admin-leave-minutes" class="form-control">
                                    </div>
                                    <div class="form-group">
                                        <label for="admin-leave-reason">Reason</label>
                                        <textarea id="admin-leave-reason" class="form-control" required></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Submit as Approved</button>
                                </form>
                            </div>
                            <div class="card">
                                <h2 class="text-xl font-bold mb-4">All Leave Requests</h2>
                                <div class="table-wrapper">
                                    <table>
                                        <thead><tr><th>Applied</th><th>Staff</th><th>Date</th><th>Type</th><th>Status</th><th>Actions</th></tr></thead>
                                        <tbody>
                                            ${allLeaves.map(l => `
                                                <tr>
                                                    <td>${utils.formatDateTime(l.appliedAt)}</td>
                                                    <td>${state.staff.find(s => s.id === l.staffId)?.name || 'Unknown'}</td>
                                                    <td>${l.date}</td>
                                                    <td>${l.type}${l.type === 'Short' ? ` (${l.minutes}m)` : ''}</td>
                                                    <td><span class="status-pill ${l.status.toLowerCase()}">${l.status}</span></td>
                                                    <td class="flex flex-wrap gap-1">
                                                        <button class="btn btn-secondary btn-sm" data-action="update-leave-status-Approved-${l.id}">Approve</button>
                                                        <button class="btn btn-secondary btn-sm" data-action="update-leave-status-Pending-${l.id}">Pend</button>
                                                        <button class="btn btn-secondary btn-sm" data-action="update-leave-status-Rejected-${l.id}">Reject</button>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                  },
                  holidays() {
                    const sortedHolidays = [...state.holidays].sort((a,b) => new Date(a.date) - new Date(b.date));
                    return `
                        <div class="grid md:grid-cols-2 gap-4">
                            <div class="card">
                                <h2 class="text-xl font-bold mb-4">Add Holiday</h2>
                                <form id="add-holiday-form">
                                    <div class="form-group">
                                        <label for="holiday-date">Date</label>
                                        <input type="date" id="holiday-date" class="form-control" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="holiday-title">Title</label>
                                        <input type="text" id="holiday-title" class="form-control" required>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Add Holiday</button>
                                </form>
                            </div>
                            <div class="card">
                                <h2 class="text-xl font-bold mb-4">All Holidays</h2>
                                <div class="table-wrapper">
                                    <table>
                                        <thead><tr><th>Date</th><th>Title</th><th>Actions</th></tr></thead>
                                        <tbody>
                                            ${sortedHolidays.map(h => `
                                                <tr>
                                                    <td>${h.date}</td>
                                                    <td>${utils.escapeHTML(h.title)}</td>
                                                    <td><button class="btn btn-danger btn-sm" data-action="delete-holiday" data-id="${h.id}">Delete</button></td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                  },
                  inbox() {
                    const requests = state.inbox.sort((a,b) => new Date(b.when) - new Date(a.when));
                    const salaryRequests = state.salaryRequests.sort((a,b) => new Date(b.when) - new Date(a.when));
                    const staffMap = new Map(state.staff.map(s => [s.id, s.name]));
                    return `
                        <div class="card mb-4">
                            <h2 class="text-xl font-bold mb-4">General Requests</h2>
                            <div class="table-wrapper">
                                <table>
                                    <thead><tr><th>When</th><th>Staff</th><th>Type</th><th>Subject</th><th>Status</th><th>Actions</th></tr></thead>
                                    <tbody>
                                        ${requests.map(r => `
                                            <tr>
                                                <td>${utils.formatDateTime(r.when)}</td>
                                                <td>${utils.escapeHTML(staffMap.get(r.staffId) || 'Unknown')}</td>
                                                <td>${utils.escapeHTML(r.type)}</td>
                                                <td>${utils.escapeHTML(r.subject)}</td>
                                                <td><span class="status-pill ${r.status.toLowerCase()}">${r.status}</span></td>
                                                <td class="flex flex-wrap gap-1">
                                                    <button class="btn btn-sm btn-secondary" data-action="update-Approved-general" data-id="${r.id}">Approve</button>
                                                    <button class="btn btn-sm btn-secondary" data-action="update-Rejected-general" data-id="${r.id}">Reject</button>
                                                </td>
                                            </tr>
                                        `).join('') || '<tr><td colspan="6" class="text-center py-4">No general requests.</td></tr>'}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="card">
                            <h2 class="text-xl font-bold mb-4">Salary Requests</h2>
                            <div class="table-wrapper">
                                <table>
                                    <thead><tr><th>When</th><th>Staff</th><th>Amount</th><th>Reason</th><th>Status</th><th>Actions</th></tr></thead>
                                    <tbody>
                                        ${salaryRequests.map(r => `
                                            <tr>
                                                <td>${utils.formatDateTime(r.when)}</td>
                                                <td>${utils.escapeHTML(staffMap.get(r.staffId) || 'Unknown')}</td>
                                                <td>${r.amount}</td>
                                                <td>${utils.escapeHTML(r.reason)}</td>
                                                <td><span class="status-pill ${r.status.toLowerCase()}">${r.status}</span></td>
                                                <td class="flex flex-wrap gap-1">
                                                    <button class="btn btn-sm btn-secondary" data-action="update-Approved-salary" data-id="${r.id}">Approve</button>
                                                    <button class="btn btn-sm btn-secondary" data-action="update-Rejected-salary" data-id="${r.id}">Reject</button>
                                                </td>
                                            </tr>
                                        `).join('') || '<tr><td colspan="6" class="text-center py-4">No salary requests.</td></tr>'}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                  },
                  rewards() {
                    return `
                        <div class="grid md:grid-cols-2 gap-4">
                            <div class="card">
                                <h2 class="text-xl font-bold mb-4">Award Points</h2>
                                <form id="award-points-form">
                                    <div class="form-group">
                                        <label for="reward-staff">Staff</label>
                                        <select id="reward-staff" class="form-control" required>
                                            ${state.staff.filter(s => s.active).map(s => `<option value="${s.id}">${utils.escapeHTML(s.name)}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="reward-points">Points</label>
                                        <input type="number" id="reward-points" class="form-control" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="reward-reason">Reason</label>
                                        <input type="text" id="reward-reason" class="form-control" required>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Award</button>
                                </form>
                            </div>
                            <div class="card">
                                <h2 class="text-xl font-bold mb-4">KPI Grid</h2>
                                <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4">
                                    ${state.staff.map(s => `
                                        <div class="kpi-card">
                                            <div class="value">${s.profile?.performance?.points || 0}</div>
                                            <div class="label">${utils.escapeHTML(s.name)}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                  },
                  settings() {
                    const { settings } = state;
                    return `
                        <div class="card max-w-3xl mx-auto">
                            <h2 class="text-xl font-bold mb-4">Settings</h2>
                            <form id="settings-form">
                                <div class="grid md:grid-cols-2 gap-4">
                                    <div class="form-group">
                                        <label for="setting-org">Organization</label>
                                        <input type="text" id="setting-org" class="form-control" value="${utils.escapeHTML(settings.org || '')}">
                                    </div>
                                    <div class="form-group">
                                        <label for="setting-webhook">Webhook URL</label>
                                        <input type="url" id="setting-webhook" class="form-control" value="${utils.escapeHTML(settings.webhook || '')}">
                                    </div>
                                    <div class="form-group">
                                        <label for="setting-break">Daily Break (mins)</label>
                                        <input type="number" id="setting-break" class="form-control" value="${settings.breakMins || 30}">
                                    </div>
                                    <div class="form-group">
                                        <label for="setting-target">Target Work (mins)</label>
                                        <input type="number" id="setting-target" class="form-control" value="${settings.targetMins || 480}">
                                    </div>
                                    <div class="form-group">
                                        <label for="setting-halfday">Half-day Cap (mins)</label>
                                        <input type="number" id="setting-halfday" class="form-control" value="${settings.halfDayMins || 240}">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Centres</label>
                                    <div id="centres-list" class="space-y-2 mb-2">
                                        ${(settings.centres || []).map(c => `
                                            <div class="flex items-center justify-between p-2 bg-secondary rounded-lg">
                                                <span>${utils.escapeHTML(c)}</span>
                                                <button type="button" class="btn btn-danger btn-sm" data-action="remove-centre" data-centre="${utils.escapeHTML(c)}">&times;</button>
                                            </div>
                                        `).join('')}
                                    </div>
                                    <div class="flex gap-2">
                                        <input type="text" id="new-centre-input" class="form-control" placeholder="Add new centre">
                                        <button type="button" id="add-centre-btn" class="btn btn-secondary">Add</button>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">Save Settings</button>
                                <p class="text-sm text-light mt-4">
                                  <strong>Webhook Info:</strong> If URL ends with .json, it will use PUT. Otherwise, POST. A successful sync might show as an "opaque" response due to CORS policy, but the server likely received the data.
                                </p>
                            </form>
                        </div>
                    `;
                  },
                  export() {
                    return `
                        <div class="card max-w-md mx-auto">
                            <h2 class="text-xl font-bold mb-4">Export Data</h2>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <button class="btn btn-secondary" data-action="export-staff">Staff CSV</button>
                                <button class="btn btn-secondary" data-action="export-sessions">Sessions CSV</button>
                                <button class="btn btn-secondary" data-action="export-leaves">Leaves CSV</button>
                                <button class="btn btn-secondary" data-action="export-shifts">Shifts CSV</button>
                            </div>
                            <hr class="my-4">
                            <button class="btn btn-primary w-full" data-action="export-json">Full JSON Backup</button>
                        </div>
                    `;
                  },
                  noticeBoard() {
                    const notices = [...state.notices].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    return `
                        <div class="grid md:grid-cols-2 gap-4">
                            <div class="card">
                                <h2 class="text-xl font-bold mb-4">Post Notice</h2>
                                <form id="post-notice-form">
                                    <div class="form-group">
                                        <label for="notice-title">Title</label>
                                        <input type="text" id="notice-title" class="form-control" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="notice-body">Body</label>
                                        <textarea id="notice-body" class="form-control" rows="4" required></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label for="notice-centre">Centre</label>
                                        <select id="notice-centre" class="form-control" required>
                                            <option value="All">All Centres</option>
                                            ${(state.settings.centres || []).map(c => `<option value="${utils.escapeHTML(c)}">${utils.escapeHTML(c)}</option>`).join('')}
                                        </select>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Post Notice</button>
                                </form>
                            </div>
                            <div class="card">
                                <h2 class="text-xl font-bold mb-4">All Notices</h2>
                                <div class="space-y-4 max-h-[60vh] overflow-y-auto">
                                  ${notices.length ? notices.map(n => `
                                    <div class="p-3 bg-secondary rounded-lg">
                                      <p class="font-bold">${utils.escapeHTML(n.title)}</p>
                                      <p class="text-sm text-light">${utils.formatDateTime(n.createdAt)} - ${utils.escapeHTML(n.centre)}</p>
                                      <p class="mt-1">${utils.escapeHTML(n.body)}</p>
                                    </div>
                                  `).join('') : '<p>No notices posted yet.</p>'}
                                </div>
                            </div>
                        </div>
                    `;
                  },
                  payroll() {
                    const currentMonth = new Date().getMonth();
                    const currentYear = new Date().getFullYear();
                    const payrollData = state.staff.map(staff => {
                        const sessionsThisMonth = state.sessions.filter(s => {
                            const sessionDate = new Date(s.date);
                            return s.staffId === staff.id && sessionDate.getMonth() === currentMonth && sessionDate.getFullYear() === currentYear;
                        });
                        
                        const uniqueDates = [...new Set(sessionsThisMonth.map(s => s.date))];
                        
                        let totalMins = 0;
                        let otMins = 0;

                        uniqueDates.forEach(date => {
                            const workedMins = utils.getWorkedMinutes(staff.id, date);
                            totalMins += workedMins;
                            otMins += Math.max(0, workedMins - (state.settings.targetMins || 480));
                        });

                        return {
                            staffName: staff.name,
                            totalHHMM: utils.minToHHMM(totalMins),
                            otHHMM: utils.minToHHMM(otMins)
                        };
                    });

                    return `
                        <div class="card">
                            <h2 class="text-xl font-bold mb-4">Payroll Rollup (This Month)</h2>
                            <div class="table-wrapper">
                                <table>
                                    <thead><tr><th>Staff</th><th>Total Worked (hh:mm)</th><th>Overtime (hh:mm)</th></tr></thead>
                                    <tbody>
                                        ${payrollData.map(p => `
                                            <tr>
                                                <td>${utils.escapeHTML(p.staffName)}</td>
                                                <td>${p.totalHHMM}</td>
                                                <td>${p.otHHMM}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                  }
                },
                staff: {
                    dashboard() {
                        const staffId = state.currentUser.id;
                        const staffMember = state.staff.find(s => s.id === staffId);
                        const profile = staffMember?.profile || {};
                        const currentMonth = new Date().getMonth();
                        const currentYear = new Date().getFullYear();

                        const sessionsThisMonth = state.sessions.filter(s => {
                            const sessionDate = new Date(s.date);
                            return s.staffId === staffId && sessionDate.getMonth() === currentMonth && sessionDate.getFullYear() === currentYear;
                        });
                        const uniqueDates = [...new Set(sessionsThisMonth.map(s => s.date))];
                        const totalMins = uniqueDates.reduce((sum, date) => sum + utils.getWorkedMinutes(staffId, date), 0);
                        
                        const leavesThisMonth = state.leaves.filter(l => {
                            const leaveDate = new Date(l.date);
                            return l.staffId === staffId && l.status === 'Approved' && leaveDate.getMonth() === currentMonth && leaveDate.getFullYear() === currentYear;
                        }).length;

                        const recentSessions = state.sessions
                            .filter(s => s.staffId === staffId)
                            .sort((a,b) => new Date(b.clockIn) - new Date(a.clockIn))
                            .slice(0, 10);

                        return `
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                                <div class="kpi-card">
                                    <div class="value">${utils.minToHHMM(totalMins)}</div>
                                    <div class="label">Worked This Month</div>
                                </div>
                                <div class="kpi-card">
                                    <div class="value">${leavesThisMonth}</div>
                                    <div class="label">Leaves This Month</div>
                                </div>
                                <div class="kpi-card">
                                    <div class="value">${profile.performance?.points || 0}</div>
                                    <div class="label">Total Points</div>
                                </div>
                            </div>
                            <div class="card">
                                <h2 class="text-xl font-bold mb-4">Recent Sessions</h2>
                                <div class="table-wrapper">
                                    <table>
                                        <thead><tr><th>Date</th><th>Centre</th><th>Clock In</th><th>Clock Out</th></tr></thead>
                                        <tbody>
                                            ${recentSessions.map(s => `
                                                <tr>
                                                    <td>${s.date}</td>
                                                    <td>${utils.escapeHTML(s.centre)}</td>
                                                    <td>${utils.formatTime(s.clockIn)}</td>
                                                    <td>${utils.formatTime(s.clockOut)}</td>
                                                </tr>
                                            `).join('') || '<tr><td colspan="4" class="text-center py-4">No recent sessions.</td></tr>'}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `;
                    },
                    clock() {
                        const today = utils.today();
                        const staffId = state.currentUser.id;
                        const todaySession = state.sessions.find(s => s.staffId === staffId && s.date === today && !s.clockOut);
                        const workedMinsToday = utils.getWorkedMinutes(staffId, today);

                        const canClockIn = !todaySession;
                        const canClockOut = todaySession && !todaySession.clockOut;
                        const canStartBreak = todaySession && !todaySession.breaks.some(b => b.start && !b.end);
                        const canEndBreak = todaySession && todaySession.breaks.some(b => b.start && !b.end);

                        return `
                            <div class="card max-w-md mx-auto">
                                <h2 class="text-xl font-bold mb-4 text-center">Time Clock</h2>
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <button class="btn btn-primary" data-action="clock-in" ${!canClockIn ? 'disabled' : ''}>Clock In</button>
                                    <button class="btn btn-primary" data-action="clock-out" ${!canClockOut ? 'disabled' : ''}>Clock Out</button>
                                    <button class="btn btn-secondary" data-action="start-break" ${!canStartBreak ? 'disabled' : ''}>Break Start</button>
                                    <button class="btn btn-secondary" data-action="end-break" ${!canEndBreak ? 'disabled' : ''}>Break End</button>
                                </div>
                                <div class="p-4 bg-secondary rounded-lg">
                                    <h3 class="font-bold">Today's Summary</h3>
                                    <p><strong>Clock In:</strong> ${utils.formatTime(todaySession?.clockIn)}</p>
                                    <p><strong>Clock Out:</strong> ${utils.formatTime(todaySession?.clockOut)}</p>
                                    <p><strong>Worked:</strong> ${utils.minToHHMM(workedMinsToday)}</p>
                                </div>
                            </div>
                        `;
                    },
                    myLeaves() {
                        const myLeaves = state.leaves
                            .filter(l => l.staffId === state.currentUser.id)
                            .sort((a,b) => new Date(b.appliedAt) - new Date(a.appliedAt));
                        return `
                            <div class="grid md:grid-cols-2 gap-4">
                                <div class="card">
                                    <h2 class="text-xl font-bold mb-4">Request Leave</h2>
                                    <form id="request-leave-form">
                                        <div class="form-group">
                                            <label for="leave-date">Date</label>
                                            <input type="date" id="leave-date" class="form-control" required value="${utils.today()}">
                                        </div>
                                        <div class="form-group">
                                            <label for="leave-type-select">Type</label>
                                            <select id="leave-type-select" class="form-control" required>
                                                <option>Full</option><option>Half</option><option>Short</option>
                                            </select>
                                        </div>
                                        <div class="form-group hidden" id="short-leave-minutes-group">
                                            <label for="leave-minutes">Minutes (for Short Leave)</label>
                                            <input type="number" id="leave-minutes" class="form-control">
                                        </div>
                                        <div class="form-group">
                                            <label for="leave-reason">Reason</label>
                                            <textarea id="leave-reason" class="form-control" required></textarea>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Submit Request</button>
                                    </form>
                                </div>
                                <div class="card">
                                    <h2 class="text-xl font-bold mb-4">My Leave History</h2>
                                    <div class="table-wrapper">
                                        <table>
                                            <thead><tr><th>Applied</th><th>Date</th><th>Type</th><th>Status</th></tr></thead>
                                            <tbody>
                                                ${myLeaves.map(l => `
                                                    <tr>
                                                        <td>${utils.formatDateTime(l.appliedAt)}</td>
                                                        <td>${l.date}</td>
                                                        <td>${l.type}${l.type === 'Short' ? ` (${l.minutes}m)` : ''}</td>
                                                        <td><span class="status-pill ${l.status.toLowerCase()}">${l.status}</span></td>
                                                    </tr>
                                                `).join('') || '<tr><td colspan="4" class="text-center py-4">No leave requests found.</td></tr>'}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        `;
                    },
                    myRequests() {
                        const myRequests = state.inbox.filter(r => r.staffId === state.currentUser.id).sort((a,b) => new Date(b.when) - new Date(a.when));
                        const mySalaryRequests = state.salaryRequests.filter(r => r.staffId === state.currentUser.id).sort((a,b) => new Date(b.when) - new Date(a.when));
                        return `
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <div class="card mb-4">
                                        <h2 class="text-xl font-bold mb-4">New General Request</h2>
                                        <form id="new-request-form">
                                            <div class="form-group">
                                                <label for="request-type">Type</label>
                                                <select id="request-type" class="form-control" required>
                                                    <option>Message</option><option>Equipment</option>
                                                </select>
                                            </div>
                                            <div class="form-group">
                                                <label for="request-subject">Subject</label>
                                                <input type="text" id="request-subject" class="form-control" required>
                                            </div>
                                            <div class="form-group">
                                                <label for="request-message">Message</label>
                                                <textarea id="request-message" class="form-control" required></textarea>
                                            </div>
                                            <button type="submit" class="btn btn-primary">Submit</button>
                                        </form>
                                    </div>
                                    <div class="card">
                                        <h2 class="text-xl font-bold mb-4">New Salary Request</h2>
                                        <form id="salary-request-form">
                                            <div class="form-group">
                                                <label for="salary-amount">Amount</label>
                                                <input type="number" id="salary-amount" class="form-control" required>
                                            </div>
                                            <div class="form-group">
                                                <label for="salary-reason">Reason</label>
                                                <textarea id="salary-reason" class="form-control" required></textarea>
                                            </div>
                                            <button type="submit" class="btn btn-primary">Submit</button>
                                        </form>
                                    </div>
                                </div>
                                <div>
                                    <div class="card mb-4">
                                        <h2 class="text-xl font-bold mb-4">My Requests</h2>
                                        <div class="table-wrapper">
                                            <table>
                                                <thead><tr><th>When</th><th>Type</th><th>Subject</th><th>Status</th></tr></thead>
                                                <tbody>
                                                    ${myRequests.map(r => `
                                                        <tr>
                                                            <td>${utils.formatDateTime(r.when)}</td>
                                                            <td>${utils.escapeHTML(r.type)}</td>
                                                            <td>${utils.escapeHTML(r.subject)}</td>
                                                            <td><span class="status-pill ${r.status.toLowerCase()}">${r.status}</span></td>
                                                        </tr>
                                                    `).join('') || '<tr><td colspan="4" class="text-center py-4">No requests found.</td></tr>'}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="card">
                                        <h2 class="text-xl font-bold mb-4">My Salary Requests</h2>
                                        <div class="table-wrapper">
                                            <table>
                                                <thead><tr><th>When</th><th>Amount</th><th>Status</th></tr></thead>
                                                <tbody>
                                                    ${mySalaryRequests.map(r => `
                                                        <tr>
                                                            <td>${utils.formatDateTime(r.when)}</td>
                                                            <td>${r.amount}</td>
                                                            <td><span class="status-pill ${r.status.toLowerCase()}">${r.status}</span></td>
                                                        </tr>
                                                    `).join('') || '<tr><td colspan="3" class="text-center py-4">No requests found.</td></tr>'}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    },
                    companyHolidays() {
                        const today = utils.today();
                        const upcomingHolidays = state.holidays
                            .filter(h => h.date >= today)
                            .sort((a,b) => new Date(a.date) - new Date(b.date));
                        return `
                            <div class="card">
                                <h2 class="text-xl font-bold mb-4">Upcoming Company Holidays</h2>
                                <div class="table-wrapper">
                                    <table>
                                        <thead><tr><th>Date</th><th>Title</th></tr></thead>
                                        <tbody>
                                            ${upcomingHolidays.map(h => `
                                                <tr><td>${h.date}</td><td>${utils.escapeHTML(h.title)}</td></tr>
                                            `).join('') || '<tr><td colspan="2" class="text-center py-4">No upcoming holidays.</td></tr>'}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `;
                    },
                    noticeBoard() {
                        const notices = [...state.notices]
                            .filter(n => n.centre === 'All' || n.centre === state.currentCentre)
                            .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                        return `
                            <div class="card">
                                <h2 class="text-xl font-bold mb-4">Notice Board</h2>
                                <div class="space-y-4 max-h-[70vh] overflow-y-auto">
                                  ${notices.length ? notices.map(n => `
                                    <div class="p-3 bg-secondary rounded-lg">
                                      <p class="font-bold">${utils.escapeHTML(n.title)}</p>
                                      <p class="text-sm text-light">${utils.formatDateTime(n.createdAt)} - ${utils.escapeHTML(n.centre)}</p>
                                      <p class="mt-1">${utils.escapeHTML(n.body)}</p>
                                    </div>
                                  `).join('') : '<p>No notices to display.</p>'}
                                </div>
                            </div>
                        `;
                    },
                    myProfile() {
                        const staffId = state.currentUser.id;
                        const staff = state.staff.find(s => s.id === staffId);
                        const profile = staff?.profile || {};
                        return `
                            <div class="card max-w-2xl mx-auto">
                                <h2 class="text-xl font-bold mb-4">My Profile</h2>
                                <p><strong>Name:</strong> ${utils.escapeHTML(staff.name)}</p>
                                <p><strong>Role:</strong> ${utils.escapeHTML(staff.role)}</p>
                                <p><strong>Default Centre:</strong> ${utils.escapeHTML(staff.defaultWorksite)}</p>
                                <p><strong>Phone:</strong> ${utils.escapeHTML(profile.phone || 'N/A')}</p>
                                <p><strong>Email:</strong> ${utils.escapeHTML(profile.email || 'N/A')}</p>
                                <p><strong>Points:</strong> ${profile.performance?.points || 0}</p>
                                <hr class="my-4">
                                <h4>My Documents</h4>
                                <ul id="my-document-list" class="list-disc pl-5 mb-4">
                                    ${(profile.documents || []).map(doc => `
                                        <li><a href="${doc.dataUrl}" download="${doc.name}">${utils.escapeHTML(doc.name)}</a></li>
                                    `).join('') || '<li>No documents uploaded.</li>'}
                                </ul>
                                <form id="upload-document-form">
                                     <div class="form-group">
                                        <label for="doc-upload">Upload New Document</label>
                                        <input type="file" id="doc-upload" class="form-control" required>
                                     </div>
                                     <button type="submit" class="btn btn-primary btn-sm">Upload</button>
                                </form>
                            </div>
                        `;
                    },
                }
            }
        };

        // --- EVENT HANDLERS & LOGIC ---
        const events = {
            auth: {
                login(e) {
                    e.preventDefault();
                    loginError.style.display = 'none';
                    const centre = centreSelect.value;
                    const pin = pinInput.value;

                    let user = null;
                    let role = null;

                    if (pin === ADMIN_PIN) {
                        user = { id: 'admin', name: 'Admin' };
                        role = 'Admin';
                    } else {
                        const staffMember = state.staff.find(s => s.pin === pin && s.active);
                        if (staffMember) {
                            user = staffMember;
                            role = 'Staff';
                        }
                    }

                    if (user) {
                        state.currentUser = { id: user.id, role: role };
                        state.currentCentre = centre;
                        stateManager.saveSessionState();
                        render.app();
                    } else {
                        loginError.style.display = 'block';
                        pinInput.value = '';
                    }
                },
                logout() {
                    state.currentUser = null;
                    state.currentCentre = null;
                    stateManager.clearSessionState();
                    render.login();
                }
            },
            navigation: {
                handleTabClick(e) {
                    if (e.target.matches('.tab-btn')) {
                        const tabName = e.target.dataset.tab;
                        render.view(tabName);
                    }
                }
            },
            header: {
                async handleActionClick(e) {
                    if (!e.target.matches('[data-action]')) return;
                    const action = e.target.dataset.action;
                    const webhookUrl = state.settings.webhook;

                    switch (action) {
                        case 'logout':
                            events.auth.logout();
                            break;
                        case 'test-webhook':
                            if (!webhookUrl) return showToast('Webhook URL not set in Settings.', 'error');
                            try {
                                await fetch(webhookUrl, { mode: 'no-cors' });
                                showToast('Test signal sent. Check your webhook server. Note: Response is hidden by CORS.', 'success');
                            } catch (err) {
                                showToast(`Webhook test failed: ${err.message}`, 'error');
                            }
                            break;
                        case 'load-webhook':
                            showToast('This feature is disabled in Firebase mode.', 'warning');
                            break;
                        case 'sync-webhook':
                            showToast('This feature is disabled in Firebase mode. Data syncs in real-time.', 'warning');
                            break;
                    }
                }
            },
            shifts: {
                async add(e) {
                    e.preventDefault();
                    const form = e.target;
                    const newShift = {
                        date: form.querySelector('#shift-date').value,
                        centre: form.querySelector('#shift-centre').value,
                        staffId: form.querySelector('#shift-staff').value,
                        start: form.querySelector('#shift-start').value,
                        end: form.querySelector('#shift-end').value,
                        notes: form.querySelector('#shift-notes').value,
                    };
                    try {
                        await addDoc(collection(db, `artifacts/${appId}/public/data/shifts`), newShift);
                        showToast('Shift added successfully.', 'success');
                        form.reset();
                    } catch (err) {
                        showToast(`Error: ${err.message}`, 'error');
                    }
                },
                async delete(id) {
                    if (confirm('Are you sure you want to delete this shift?')) {
                        try {
                            await deleteDoc(doc(db, `artifacts/${appId}/public/data/shifts`, id));
                            showToast('Shift deleted.', 'success');
                        } catch (err) {
                            showToast(`Error: ${err.message}`, 'error');
                        }
                    }
                }
            },
            staff: {
                async add(e) {
                    e.preventDefault();
                    const form = e.target;
                    const id = form.querySelector('#staff-id').value;
                    if (state.staff.some(s => s.id === id)) {
                        return showToast('Staff ID already exists.', 'error');
                    }
                    const newStaff = {
                        id,
                        name: form.querySelector('#staff-name').value,
                        role: form.querySelector('#staff-role').value,
                        pin: form.querySelector('#staff-pin').value,
                        defaultWorksite: form.querySelector('#staff-centre').value,
                        joinDate: utils.today(),
                        active: true,
                        profile: { phone: "", email: "", performance: { points: 0 }, documents: [] }
                    };
                    try {
                        await setDoc(doc(db, `artifacts/${appId}/public/data/staff`, id), newStaff);
                        showToast('Staff added successfully.', 'success');
                        form.reset();
                    } catch (err) {
                        showToast(`Error: ${err.message}`, 'error');
                    }
                },
                async toggleStatus(id) {
                    const staffMember = state.staff.find(s => s.id === id);
                    if (staffMember) {
                        try {
                            const staffDocRef = doc(db, `artifacts/${appId}/public/data/staff`, id);
                            await updateDoc(staffDocRef, { active: !staffMember.active });
                            showToast('Staff status updated.', 'success');
                        } catch (err) {
                            showToast(`Error: ${err.message}`, 'error');
                        }
                    }
                },
                async remove(id) {
                    if (confirm('Are you sure? This will remove the staff and their profile permanently.')) {
                        try {
                            await deleteDoc(doc(db, `artifacts/${appId}/public/data/staff`, id));
                            showToast('Staff removed.', 'success');
                        } catch (err) {
                            showToast(`Error: ${err.message}`, 'error');
                        }
                    }
                },
                viewProfile(id) {
                    render.profileDrawer(id);
                }
            },
            leaves: {
                async adminSubmit(e) {
                    e.preventDefault();
                    const form = e.target;
                    const type = form.querySelector('#admin-leave-type').value;
                    const newLeave = {
                        staffId: form.querySelector('#admin-leave-staff').value,
                        date: form.querySelector('#admin-leave-date').value,
                        type,
                        minutes: type === 'Short' ? parseInt(form.querySelector('#admin-leave-minutes').value) || 0 : 0,
                        reason: form.querySelector('#admin-leave-reason').value,
                        status: 'Approved',
                        appliedAt: new Date().toISOString(),
                    };
                    try {
                        await addDoc(collection(db, `artifacts/${appId}/public/data/leaves`), newLeave);
                        showToast('Leave submitted as Approved.', 'success');
                        form.reset();
                    } catch (err) {
                        showToast(`Error: ${err.message}`, 'error');
                    }
                },
                async updateStatus(id, status) {
                    try {
                        const leaveDocRef = doc(db, `artifacts/${appId}/public/data/leaves`, id);
                        await updateDoc(leaveDocRef, { status });
                        showToast(`Leave status updated to ${status}.`, 'success');
                    } catch (err) {
                        showToast(`Error: ${err.message}`, 'error');
                    }
                },
                async staffRequest(e) {
                    e.preventDefault();
                    const form = e.target;
                    const type = form.querySelector('#leave-type-select').value;
                    const newLeave = {
                        staffId: state.currentUser.id,
                        date: form.querySelector('#leave-date').value,
                        type,
                        minutes: type === 'Short' ? parseInt(form.querySelector('#leave-minutes').value) || 0 : 0,
                        reason: form.querySelector('#leave-reason').value,
                        status: 'Pending',
                        appliedAt: new Date().toISOString(),
                    };
                    try {
                        await addDoc(collection(db, `artifacts/${appId}/public/data/leaves`), newLeave);
                        showToast('Leave request submitted.', 'success');
                        form.reset();
                    } catch (err) {
                        showToast(`Error: ${err.message}`, 'error');
                    }
                }
            },
            holidays: {
                async add(e) {
                    e.preventDefault();
                    const form = e.target;
                    const newHoliday = {
                        date: form.querySelector('#holiday-date').value,
                        title: form.querySelector('#holiday-title').value,
                    };
                    try {
                        await addDoc(collection(db, `artifacts/${appId}/public/data/holidays`), newHoliday);
                        showToast('Holiday added.', 'success');
                        form.reset();
                    } catch (err) {
                        showToast(`Error: ${err.message}`, 'error');
                    }
                },
                async delete(id) {
                    if (confirm('Are you sure?')) {
                        try {
                            await deleteDoc(doc(db, `artifacts/${appId}/public/data/holidays`, id));
                            showToast('Holiday deleted.', 'success');
                        } catch (err) {
                            showToast(`Error: ${err.message}`, 'error');
                        }
                    }
                }
            },
            inbox: {
                async updateStatus(id, status, type) {
                    const collectionName = type === 'general' ? 'inbox' : 'salaryRequests';
                    try {
                        const docRef = doc(db, `artifacts/${appId}/public/data/${collectionName}`, id);
                        await updateDoc(docRef, { status });
                        showToast('Request status updated.', 'success');
                    } catch (err) {
                        showToast(`Error: ${err.message}`, 'error');
                    }
                }
            },
            rewards: {
                async award(e) {
                    e.preventDefault();
                    const form = e.target;
                    const staffId = form.querySelector('#reward-staff').value;
                    const points = parseInt(form.querySelector('#reward-points').value);
                    if (isNaN(points)) return showToast('Invalid points value.', 'error');
                    
                    const staffMember = state.staff.find(s => s.id === staffId);
                    if (!staffMember) return showToast('Staff not found', 'error');

                    const currentPoints = staffMember.profile?.performance?.points || 0;
                    const newPoints = currentPoints + points;

                    try {
                        const staffDocRef = doc(db, `artifacts/${appId}/public/data/staff`, staffId);
                        await updateDoc(staffDocRef, { 'profile.performance.points': newPoints });
                        showToast(`${points} points awarded.`, 'success');
                        form.reset();
                    } catch (err) {
                        showToast(`Error: ${err.message}`, 'error');
                    }
                }
            },
            settings: {
                async save(e) {
                    e.preventDefault();
                    const newSettings = {
                        org: $('#setting-org').value,
                        webhook: $('#setting-webhook').value,
                        breakMins: parseInt($('#setting-break').value),
                        targetMins: parseInt($('#setting-target').value),
                        halfDayMins: parseInt($('#setting-halfday').value),
                        centres: state.settings.centres || []
                    };
                    
                    try {
                        await setDoc(doc(db, `artifacts/${appId}/public/data/config/settings`), newSettings);
                        showToast('Settings saved.', 'success');
                    } catch (err) {
                        showToast(`Error: ${err.message}`, 'error');
                    }
                },
                async addCentre() {
                    const newCentreInput = $('#new-centre-input');
                    const newCentre = newCentreInput.value.trim();
                    if (newCentre && !state.settings.centres.includes(newCentre)) {
                        const updatedCentres = [...state.settings.centres, newCentre];
                        try {
                            const settingsDocRef = doc(db, `artifacts/${appId}/public/data/config/settings`);
                            await updateDoc(settingsDocRef, { centres: updatedCentres });
                            showToast('Centre added.', 'success');
                            newCentreInput.value = '';
                        } catch (err) {
                            showToast(`Error: ${err.message}`, 'error');
                        }
                    }
                },
                async removeCentre(centre) {
                    if (confirm(`Remove centre "${centre}"?`)) {
                        const updatedCentres = state.settings.centres.filter(c => c !== centre);
                        try {
                            const settingsDocRef = doc(db, `artifacts/${appId}/public/data/config/settings`);
                            await updateDoc(settingsDocRef, { centres: updatedCentres });
                            showToast('Centre removed.', 'success');
                        } catch (err) {
                            showToast(`Error: ${err.message}`, 'error');
                        }
                    }
                }
            },
            export: {
                _download(filename, text) {
                    const element = document.createElement('a');
                    element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
                    element.setAttribute('download', filename);
                    element.style.display = 'none';
                    document.body.appendChild(element);
                    element.click();
                    document.body.removeChild(element);
                },
                _toCSV(data, headers) {
                    const headerRow = headers.join(',');
                    const rows = data.map(obj => 
                        headers.map(header => JSON.stringify(obj[header.toLowerCase()] || '')).join(',')
                    );
                    return [headerRow, ...rows].join('\r\n');
                },
                staff() { this._download('staff.csv', this._toCSV(state.staff, ['ID', 'Name', 'Role', 'DefaultWorksite', 'JoinDate', 'Active'])); },
                sessions() { this._download('sessions.csv', this._toCSV(state.sessions, ['ID', 'StaffID', 'Date', 'Centre', 'ClockIn', 'ClockOut'])); },
                leaves() { this._download('leaves.csv', this._toCSV(state.leaves, ['ID', 'StaffID', 'Date', 'Type', 'Minutes', 'Status'])); },
                shifts() { this._download('shifts.csv', this._toCSV(state.shifts, ['ID', 'StaffID', 'Date', 'Centre', 'Start', 'End'])); },
                json() {
                    const filename = `mls_backup_${utils.today()}.json`;
                    this._download(filename, JSON.stringify(state, null, 2));
                }
            },
            notices: {
                async add(e) {
                    e.preventDefault();
                    const form = e.target;
                    const newNotice = {
                        title: form.querySelector('#notice-title').value,
                        body: form.querySelector('#notice-body').value,
                        centre: form.querySelector('#notice-centre').value,
                        createdAt: new Date().toISOString(),
                    };
                    try {
                        await addDoc(collection(db, `artifacts/${appId}/public/data/notices`), newNotice);
                        showToast('Notice posted.', 'success');
                        form.reset();
                    } catch (err) {
                        showToast(`Error: ${err.message}`, 'error');
                    }
                }
            },
            clock: {
                _getCurrentSession() {
                    const today = utils.today();
                    const staffId = state.currentUser.id;
                    return state.sessions.find(s => s.staffId === staffId && s.date === today && !s.clockOut);
                },
                async clockIn() {
                    if (this._getCurrentSession()) return showToast('Already clocked in.', 'error');
                    const newSession = {
                        staffId: state.currentUser.id,
                        date: utils.today(),
                        centre: state.currentCentre,
                        clockIn: new Date().toISOString(),
                        clockOut: null,
                        breaks: [],
                    };
                    try {
                        await addDoc(collection(db, `artifacts/${appId}/public/data/sessions`), newSession);
                        showToast('Clocked in successfully.', 'success');
                    } catch (err) {
                        showToast(`Error: ${err.message}`, 'error');
                    }
                },
                async clockOut() {
                    const session = this._getCurrentSession();
                    if (!session) return showToast('Not clocked in.', 'error');
                    try {
                        const sessionDocRef = doc(db, `artifacts/${appId}/public/data/sessions`, session.id);
                        await updateDoc(sessionDocRef, { clockOut: new Date().toISOString() });
                        showToast('Clocked out successfully.', 'success');
                    } catch (err) {
                        showToast(`Error: ${err.message}`, 'error');
                    }
                },
                async startBreak() {
                    const session = this._getCurrentSession();
                    if (!session) return showToast('Not clocked in.', 'error');
                    if (session.breaks.some(b => b.start && !b.end)) return showToast('Already on a break.', 'error');
                    
                    const newBreaks = [...session.breaks, { start: new Date().toISOString(), end: null }];
                    try {
                        const sessionDocRef = doc(db, `artifacts/${appId}/public/data/sessions`, session.id);
                        await updateDoc(sessionDocRef, { breaks: newBreaks });
                        showToast('Break started.', 'success');
                    } catch (err) {
                        showToast(`Error: ${err.message}`, 'error');
                    }
                },
                async endBreak() {
                    const session = this._getCurrentSession();
                    if (!session) return showToast('Not clocked in.', 'error');
                    const activeBreakIndex = session.breaks.findIndex(b => b.start && !b.end);
                    if (activeBreakIndex === -1) return showToast('Not on a break.', 'error');

                    const newBreaks = [...session.breaks];
                    newBreaks[activeBreakIndex].end = new Date().toISOString();
                     try {
                        const sessionDocRef = doc(db, `artifacts/${appId}/public/data/sessions`, session.id);
                        await updateDoc(sessionDocRef, { breaks: newBreaks });
                        showToast('Break ended.', 'success');
                    } catch (err) {
                        showToast(`Error: ${err.message}`, 'error');
                    }
                },
            },
            requests: {
                async submitGeneral(e) {
                    e.preventDefault();
                    const form = e.target;
                    const newRequest = {
                        staffId: state.currentUser.id,
                        when: new Date().toISOString(),
                        type: form.querySelector('#request-type').value,
                        subject: form.querySelector('#request-subject').value,
                        message: form.querySelector('#request-message').value,
                        status: 'Pending'
                    };
                    try {
                        await addDoc(collection(db, `artifacts/${appId}/public/data/inbox`), newRequest);
                        showToast('Request submitted.', 'success');
                        form.reset();
                    } catch (err) {
                        showToast(`Error: ${err.message}`, 'error');
                    }
                },
                async submitSalary(e) {
                    e.preventDefault();
                    const form = e.target;
                    const newRequest = {
                        staffId: state.currentUser.id,
                        when: new Date().toISOString(),
                        amount: parseFloat(form.querySelector('#salary-amount').value),
                        reason: form.querySelector('#salary-reason').value,
                        status: 'Pending'
                    };
                    try {
                        await addDoc(collection(db, `artifacts/${appId}/public/data/salaryRequests`), newRequest);
                        showToast('Salary request submitted.', 'success');
                        form.reset();
                    } catch (err) {
                        showToast(`Error: ${err.message}`, 'error');
                    }
                }
            },
            profile: {
                _handleFileUpload(file, staffId) {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const newDoc = {
                            name: file.name,
                            dataUrl: e.target.result,
                            uploadedAt: new Date().toISOString()
                        };
                        
                        const staffMember = state.staff.find(s => s.id === staffId);
                        if (!staffMember) return;

                        const newDocuments = [...(staffMember.profile.documents || []), newDoc];
                        
                        try {
                            const staffDocRef = doc(db, `artifacts/${appId}/public/data/staff`, staffId);
                            await updateDoc(staffDocRef, { 'profile.documents': newDocuments });
                            showToast('Document uploaded.', 'success');
                        } catch (err) {
                             showToast(`Error: ${err.message}`, 'error');
                        }
                    };
                    reader.readAsDataURL(file);
                },
                uploadDocument(e) {
                    e.preventDefault();
                    const file = e.target.querySelector('#doc-upload').files[0];
                    if (file) {
                        events.profile._handleFileUpload(file, state.currentUser.id);
                    }
                },
                uploadDocumentFromDrawer(e) {
                    e.preventDefault();
                    const staffId = e.target.querySelector('input[name="staffId"]').value;
                    const file = e.target.querySelector('#profile-doc-upload').files[0];
                    if (file && staffId) {
                        events.profile._handleFileUpload(file, staffId);
                    }
                }
            }
        };

        // --- TOAST NOTIFICATIONS ---
        function showToast(message, type = 'info', duration = 3000) {
            const container = $('#toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);

            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, duration);
        }

        // --- APP INITIALIZATION ---
        async function init() {
            // Global event listeners
            loginForm.addEventListener('submit', events.auth.login);
            tabNav.addEventListener('click', events.navigation.handleTabClick);
            headerActions.addEventListener('click', events.header.handleActionClick);
            
            drawerClose.addEventListener('click', () => {
                profileDrawerOverlay.classList.remove('open');
                profileDrawer.classList.remove('open');
            });
            profileDrawerOverlay.addEventListener('click', (e) => {
                if (e.target === profileDrawerOverlay) {
                    profileDrawerOverlay.classList.remove('open');
                    profileDrawer.classList.remove('open');
                }
            });

            await stateManager.initFirebase();
        }

        // --- START THE APP ---
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
